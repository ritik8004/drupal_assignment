<project name="custom" default="setup">
  <target name="local:reset-settings-file">
    <echo>Allow editing settings.php file.</echo>
    <chmod mode="0755" file="${docroot}/sites/${multisite.name}" failonerror="false"/>
    <chmod mode="0644" file="${docroot}/sites/${multisite.name}/settings.php" failonerror="false"/>

    <echo>Revert settings.php file to avoid GIT issues.</echo>
    <exec dir="${repo.root}" command="git checkout docroot/sites/${multisite.name}/settings.php" logoutput="true" checkreturn="true" level="${blt.exec_level}" passthru="true" />
  </target>

  <target name="local:reset-local-settings">
    <if>
      <not><available file="${docroot}/sites/${multisite.name}/settings" type="dir" property="dirExists" /></not>
      <then>
        <echo>Creating settings directory for the site:</echo>
        <exec dir="${docroot}/sites/${multisite.name}" command="mkdir settings" logoutput="true" checkreturn="true" level="${blt.exec_level}" passthru="true"/>
      </then>
    </if>

    <chmod mode="0755" file="${docroot}/sites/${multisite.name}" failonerror="false"/>
    <chmod mode="0755" file="${docroot}/sites/${multisite.name}/settings/" failonerror="false"/>
    <if>
      <available file="${docroot}/sites/${multisite.name}/settings/local.settings.php"/>
      <then>
        <chmod mode="0644" file="${docroot}/sites/${multisite.name}/settings/local.settings.php" failonerror="false"/>
      </then>
    </if>

    <echo>Generating ${docroot}/sites/${multisite.name}/settings/local.settings.php</echo>
    <copy file="${docroot}/sites/default/settings/default.local.settings.php" tofile="${docroot}/sites/${multisite.name}/settings/local.settings.php" verbose="true"/>
  </target>

  <target name="local:post-install">
    <echo>Allow all modules to run code once post drupal install.</echo>
    <drush command="alshaya-post-drupal-install" assume="yes" alias="${drush.alias}" passthru="false">
        <option name="brand_module">${drush.brand_module}</option>
    </drush>
  </target>

  <target name="sync:products">
    <echo>Sync the categories.</echo>
    <drush command="alshaya-acm-offline-categories-sync" assume="yes" alias="${drush.alias}" passthru="false" />

    <echo>Sync the product options.</echo>
    <drush command="sync-commerce-product-options" assume="yes" alias="${drush.alias}" passthru="false" />

    <echo>Sync the products.</echo>
    <drush command="alshaya-acm-offline-products-sync" assume="yes" alias="${drush.alias}" passthru="false">
      <option name="limit">200</option>
    </drush>
  </target>

  <target name="sync:stores">
    <echo>Sync the stores</echo>
    <drush command="alshaya-api-sync-stores" assume="yes" alias="${drush.alias}" passthru="false" />
  </target>

  <target name="sync:promotions">
    <echo>Sync the promotions.</echo>
    <drush command="sync-commerce-promotions" assume="yes" alias="${drush.alias}" passthru="false" />
  </target>

  <target name="refresh:local"
          description="Setup local dev environment.">
      <if>
        <not><isset property="site" /></not>
        <then><input propertyname="site">Enter site code to reinstall:</input></then>
      </if>

      <phingcall target="local:reset-local-settings"/>
      <phingcall target="local:setup">
          <property name="drush.uri" value="${sites.${site}.alias}" />
          <property name="project.profile.name" value="${sites.${site}.type}" />
      </phingcall>
      <phingcall target="local:reset-settings-file"/>
      <phingcall target="local:post-install">
          <property name="drush.uri" value="${sites.${site}.alias}" />
          <property name="drush.brand_module" value="${sites.${site}.module}" />
      </phingcall>

      <!-- Following commands are required only for transac -->
      <if>
        <equals arg1="${sites.${site}.type}" arg2="alshaya_transac" />
        <then>
          <phingcall target="sync:products">
              <property name="drush.uri" value="${sites.${site}.alias}" />
          </phingcall>
          <phingcall target="sync:promotions">
              <property name="drush.uri" value="${sites.${site}.alias}" />
          </phingcall>
          <phingcall target="sync:stores">
              <property name="drush.uri" value="${sites.${site}.alias}" />
          </phingcall>
        </then>
      </if>
  </target>

  <target name="refresh:local:drupal"
          description="Reinstall local dev environment.">
      <if>
        <not><isset property="site" /></not>
        <then><input propertyname="site">Enter site code to reinstall:</input></then>
      </if>

      <phingcall target="setup:composer:install"/>
      <phingcall target="frontend:build"/>
      <phingcall target="local:reset-local-settings"/>
      <phingcall target="local:drupal:install">
          <property name="drush.uri" value="${sites.${site}.alias}" />
          <property name="project.profile.name" value="${sites.${site}.type}" />
      </phingcall>
      <phingcall target="setup:toggle-modules">
          <property name="drush.uri" value="${sites.${site}.alias}" />
      </phingcall>
      <phingcall target="local:reset-settings-file"/>
      <phingcall target="local:post-install">
          <property name="drush.uri" value="${sites.${site}.alias}" />
          <property name="drush.brand_module" value="${sites.${site}.module}" />
      </phingcall>

      <!-- Following commands are required only for transac -->
      <if>
        <equals arg1="${sites.${site}.type}" arg2="alshaya_transac" />
        <then>
          <phingcall target="sync:products">
              <property name="drush.uri" value="${sites.${site}.alias}" />
          </phingcall>
          <phingcall target="sync:promotions">
              <property name="drush.uri" value="${sites.${site}.alias}" />
          </phingcall>
          <phingcall target="sync:stores">
              <property name="drush.uri" value="${sites.${site}.alias}" />
          </phingcall>
        </then>
      </if>
  </target>
</project>
