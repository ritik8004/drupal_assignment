<project name="custom" default="setup">
  <target name="local:reset-settings-file">
    <echo>Allow editing settings.php file.</echo>
    <chmod mode="0755" file="${docroot}/sites/${multisite.name}" failonerror="false"/>
    <chmod mode="0644" file="${docroot}/sites/${multisite.name}/settings.php" failonerror="false"/>

    <echo>Revert settings.php file to avoid GIT issues.</echo>
    <exec dir="${repo.root}" command="git checkout docroot/sites/${multisite.name}/settings.php" logoutput="true" checkreturn="true" level="${blt.exec_level}" passthru="true" />

    <echo>Revert file permissions for settings.php file.</echo>
    <chmod mode="0544" file="${docroot}/sites/${multisite.name}" failonerror="false"/>
    <chmod mode="0444" file="${docroot}/sites/${multisite.name}/settings.php" failonerror="false"/>
  </target>

  <target name="sync:products">
    <echo>Sync the categories.</echo>
    <drush command="alshaya-acm-offline-categories-sync" assume="yes" alias="${drush.alias}" passthru="false" />

    <echo>Sync the products.</echo>
    <drush command="alshaya-acm-offline-products-sync" assume="yes" alias="${drush.alias}" passthru="false">
      <option name="limit">200</option>
    </drush>
  </target>

  <target name="sync:product-images">
    <echo>Download some product images by running the queue for ~60 seconds.</echo>
    <drush command="queue-run" alias="${drush.alias}" passthru="false" verbose="${blt.verbose}">
      <param>acq_sku_download_product_images</param>
      <option name="time-limit">60</option>
    </drush>
  </target>

  <target name="refresh:local"
          description="Setup local dev environment."
          depends="local:setup, local:reset-settings-file, sync:products, sync:product-images">
  </target>

  <target name="refresh:local:drupal"
          description="Reinstall local dev environment."
          depends="setup:composer:install, frontend:build, local:drupal:install, local:reset-settings-file, sync:products, sync:product-images">
  </target>
</project>
