<?php

/**
 * @file
 * Module file.
 */

use Drupal\Core\Cache\Cache;
use Drupal\Core\Url;
use Drupal\node\NodeInterface;
use Drupal\taxonomy\Entity\Term;
use Drupal\taxonomy\TermInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Access\AccessResult;
use Drupal\alshaya_acm_product_category\ProductCategoryTree;
use Drupal\alshaya_acm_product_category\Service\ProductCategoryManager;

/**
 * Implements hook_module_implements_alter().
 */
function alshaya_acm_product_category_module_implements_alter(&$implementations, $hook) {
  // To call the alshaya_acm_product_category_acq_sku_product_node_alter first.
  // We want to categorise first before creating color nodes.
  if ($hook == 'acq_sku_product_node_alter') {
    $group = $implementations['alshaya_acm_product_category'];
    unset($implementations['alshaya_acm_product_category']);
    $implementations = ['alshaya_acm_product_category' => $group] + $implementations;
  }
}

/**
 * Implements hook_theme().
 */
function alshaya_acm_product_category_theme($existing, $type, $theme, $path) {
  return [
    'alshaya_shop_by' => [
      'template' => 'alshaya-shop-by',
      'variables' => [
        'term_tree' => NULL,
      ],
    ],
    'alshaya_lhn_tree' => [
      'template' => 'alshaya-lhn',
      'variables' => [
        'lhn_cat_tree' => NULL,
        'current_term' => NULL,
        'depth_offset' => NULL,
        'current_term_parent_id' => NULL,
      ],
    ],
  ];
}

/**
 * Implements template_preprocess_hook().
 */
function template_preprocess_alshaya_shop_by(&$variables) {
  // Split/Chunk the array into two parts.
  $variables['term_tree'] = array_chunk($variables['term_tree'], ceil(count($variables['term_tree']) / 2));
}

/**
 * Implements hook_preprocess_block().
 */
function alshaya_acm_product_category_preprocess_block(&$variables) {
  if ($variables['plugin_id'] == 'views_block:plp_promotional_banner-block_1') {
    // If plp promotional banner block.
    $term = \Drupal::routeMatch()->getParameter('taxonomy_term');
    $hide_for_mobile = $term ? _alshaya_acm_product_category_hide_plp_banner_for_mobile($term) : FALSE;
    if ($hide_for_mobile) {
      $variables['content']['#attributes']['class'][] = 'hide-on-mobile';
    }
  }
}

/**
 * Hide or not PLP banner for mobile.
 *
 * @param \Drupal\taxonomy\Entity\Term $term
 *   Term object.
 *
 * @return bool
 *   PLP banner for mobile hide or not.
 */
function _alshaya_acm_product_category_hide_plp_banner_for_mobile(Term $term) {
  if ($mobile_banner = $term->get('field_promo_banner_for_mobile')) {
    return $mobile_banner->getValue() ? (bool) $mobile_banner->getValue()[0]['value'] : FALSE;
  }

  return FALSE;
}

/**
 * Implements hook_acq_sku_commerce_category_alter().
 */
function alshaya_acm_product_category_acq_sku_commerce_category_alter(TermInterface $term, array $category, $parent) {
  // We consider status of parent category too for a particular category.
  // If parent term not available, no additional condition required.
  if ($parent instanceof TermInterface) {
    /** @var \Drupal\acq_commerce\I18nHelper $i18nHelper */
    $i18nHelper = \Drupal::service('acq_commerce.i18n_helper');

    $langcode = $i18nHelper->getLangcodeFromStoreId($category['store_id']);

    // Get current language translation if available.
    if ($parent->hasTranslation($langcode)) {
      $parent = $parent->getTranslation($langcode);
    }

    // We set status to enabled only if both parent and child are enabled.
    $status = $parent->get('field_commerce_status')->getstring() && (int) $category['is_active'];
    $term->get('field_commerce_status')->setValue((int) $status);

    // Set children as not included in menu if the parent is being set to be
    // excluded from menu.
    if ($parent->get('field_category_include_menu')->getString() == 0 && $category['in_menu'] == 1) {
      $term->get('field_category_include_menu')->setValue(0);
    }
  }
}

/**
 * Get all the children of given terms.
 *
 * @param int $tid
 *   The term id.
 */
function alshaya_acm_product_category_child_terms($tid) {
  $langcode = \Drupal::service('language_manager')->getCurrentLanguage()->getId();
  $terms = \Drupal::service('alshaya_acm_product_category.product_category_tree')->allChildTerms($langcode, $tid, FALSE, TRUE);

  $data = [];
  foreach ($terms as $term) {
    $data[$term->tid] = [
      'label' => $term->name,
      'description'  => [
        '#markup' => $term->description__value,
      ],
      'id' => $term->tid,
      'path' => Url::fromRoute('entity.taxonomy_term.canonical', ['taxonomy_term' => $term->tid])->toString(),
      'active_class' => '',
    ];
  }
  return $data;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function alshaya_acm_product_category_form_views_exposed_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if (($form['#id'] === 'views-exposed-form-alshaya-product-list-block-1') ||
    ($form['#id'] === 'views-exposed-form-alshaya-product-list-block-2')) {
    // Hide sort options on campaign-plp-style-1.
    $term = \Drupal::service('alshaya_acm_product_category.product_category_tree')->getCategoryTermFromRoute();
    if ($term instanceof TermInterface && $term->get('field_plp_layout')->value == ProductCategoryTree::PLP_LAYOUT_1) {
      $form['sort_bef_combine']['#type'] = 'hidden';
    }
  }
}

/**
 * Implements hook_entity_field_access_alter().
 */
function alshaya_acm_product_category_entity_field_access_alter(array &$grants, array $context) {
  if ($context['operation'] === 'view' && $context['field_definition']->getTargetEntityTypeId() === 'taxonomy_term' && $context['field_definition']->getname() === 'field_plp_menu') {
    $term = \Drupal::service('alshaya_acm_product_category.product_category_tree')->getCategoryTermFromRoute();
    if ($term instanceof TermInterface && $term->get('field_plp_layout')->value != ProductCategoryTree::PLP_LAYOUT_1) {
      // Do not show this field on pages that are not campaign-plp-style-1.
      $grants[':default'] = AccessResult::forbidden()->inheritCacheability($grants[':default'])->addCacheableDependency($context['items']->getEntity());
    }
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function alshaya_acm_product_category_field_widget_link_default_form_alter(&$element, FormStateInterface $form_state, $context) {
  if (($context['items']->getName() == 'field_plp_video_links')) {
    $element['uri']['#description'] = t('Please enter the link of the video. It could be a youtube/vimeo video or a custom video that you have uploaded to the site. To upload a video, use the Upload Video field below and then add the link here.');
  }
}

/**
 * Implements allowed values callback for PLP layout.
 */
function alshaya_acm_product_category_plp_layout_values() {
  $config = \Drupal::config('alshaya_master.plp_settings');
  // Prepare PDP layout select options.
  $plp_layout_options = [];
  $plp_layout_options += $config->get('all_plp_layouts');
  return $plp_layout_options;
}

/**
 * Implements hook_link_attributes_plugin_alter().
 */
function alshaya_acm_product_category_link_attributes_plugin_alter(array &$definitions) {
  $definitions['class']['description'] = t('Select how the link should be displayed.');
  $definitions['class']['type'] = 'select';
  $definitions['class']['options'] = [
    '' => 'None',
    'campaign-plp-style-1-modal-link use-ajax' => 'Campaign PLP Style 1 Modal',
  ];
  $definitions['class']['default_value'] = '';
}

/**
 * Implements hook_acq_sku_product_node_alter().
 */
function alshaya_acm_product_category_acq_sku_product_node_alter(NodeInterface $node, $product) {
  // Set the category from ACM field to our backup field.
  $node->get('field_category_original')->setValue($node->get('field_category')->getValue());

  /** @var \Drupal\alshaya_acm_product_category\Service\ProductCategoryManager $manager */
  $manager = \Drupal::service('alshaya_acm_product_category.sales_category_manager');
  $manager->processCategorizationCheckForNode($node);
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function alshaya_acm_product_category_taxonomy_term_insert(TermInterface $term) {
  if ($term->bundle() == ProductCategoryTree::VOCABULARY_ID) {
    _alshaya_acm_product_category_taxonomy_term_updated_operation($term);
  }
}

/**
 * Implements hook_ENTITY_TYPE_insert() for taxonomy_term entities.
 */
function alshaya_acm_product_category_taxonomy_term_update(TermInterface $term) {
  if ($term->bundle() == ProductCategoryTree::VOCABULARY_ID) {
    _alshaya_acm_product_category_taxonomy_term_updated_operation($term);
  }
}

/**
 * Implements hook_ENTITY_TYPE_delete().
 */
function alshaya_acm_product_category_taxonomy_term_delete(TermInterface $term) {
  if ($term->bundle() == ProductCategoryTree::VOCABULARY_ID) {
    _alshaya_acm_product_category_taxonomy_term_updated_operation($term);
  }
}

/**
 * Act on insert/update/delete of category term.
 *
 * @param \Drupal\taxonomy\TermInterface $term
 *   Category term.
 */
function _alshaya_acm_product_category_taxonomy_term_updated_operation(TermInterface $term) {
  /** @var \Drupal\taxonomy\TermStorage $termStorage */
  $termStorage = \Drupal::entityTypeManager()->getStorage('taxonomy_term');
  $parents = $termStorage->loadAllParents($term->id());
  $term_ids = $parents ? array_keys($parents) : [$term->id()];

  /** @var \Drupal\alshaya_acm_product_category\Service\ProductCategoryManager $manager */
  $manager = \Drupal::service('alshaya_acm_product_category.sales_category_manager');
  $sale_ids = $manager->getCategorizationIds()['sale'] ?? [];

  // Invalidate cache if term or it's parent are part of sales category tree.
  if (array_intersect($sale_ids, $term_ids)) {
    Cache::invalidateTags([ProductCategoryManager::CATEGORIZATION_IDS_CACHE_TAG]);
  }
}

/**
 * Implements hook_pathauto_alias_alter().
 */
function alshaya_acm_product_category_pathauto_alias_alter(&$alias, array $context) {
  if ($context['module'] != 'taxonomy' || $context['bundle'] != ProductCategoryTree::VOCABULARY_ID) {
    return;
  }

  // Return if already modified by alshaya_super_category.
  if (\Drupal::moduleHandler()->moduleExists('alshaya_super_category') && \Drupal::config('alshaya_super_category.settings')->get('status')) {
    return;
  }

  // For all the category terms we want shop- prefix for L1 only.
  $alias = '/shop-' . ltrim($alias, '/');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function alshaya_acm_product_category_form_taxonomy_term_acq_product_category_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['field_promotion_banner_mobile']['#states'] = [
    'invisible' => [
      'input[name="field_promo_banner_for_mobile[value]"]' => ['checked' => TRUE],
    ],
  ];

  $form['field_display_as_clickable_link']['widget']['value']['#states'] = [
    'required' => [
      ':input[name="field_override_target_link[value]"]' => ['checked' => TRUE],
    ],
  ];

  $form['field_target_link']['#states'] = [
    'visible' => [
      ':input[name="field_override_target_link[value]"]' => ['checked' => TRUE],
    ],
  ];
  $form['field_target_link']['widget'][0]['uri']['#states'] = [
    'required' => [
      ':input[name="field_override_target_link[value]"]' => ['checked' => TRUE],
    ],
  ];

  $form['field_include_in_desktop']['#states'] = [
    'visible' => [
      ':input[name="field_category_include_menu[value]"]' => ['checked' => TRUE],
    ],
  ];

  $form['field_include_in_mobile_tablet']['#states'] = [
    'visible' => [
      ':input[name="field_category_include_menu[value]"]' => ['checked' => TRUE],
    ],
  ];

  $form['path']['widget']['#after_build'][] = 'alshaya_acm_product_category_after_build';
}

/**
 * After build callback to uncheck auto generate path auto.
 *
 * @param array $element
 *   Array of current element.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   Form state object.
 *
 * @return array
 *   Return element array.
 */
function alshaya_acm_product_category_after_build(array $element, FormStateInterface $form_state) {
  $element[0]['pathauto']['#states'] = [
    'unchecked' => [
      ':input[name="field_override_target_link[value]"]' => ['checked' => TRUE],
    ],
  ];

  $element[0]['alias']['#states'] = [
    'empty' => [
      ':input[name="field_override_target_link[value]"]' => ['checked' => TRUE],
    ],
  ];

  return $element;
}
