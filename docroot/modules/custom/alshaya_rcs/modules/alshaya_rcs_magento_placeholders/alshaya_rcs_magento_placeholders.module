<?php

/**
 * @file
 * Module file.
 */

use Drupal\Core\Site\Settings;

/**
 * Implements hook_page_attachments().
 */
function alshaya_rcs_magento_placeholders_page_attachments_alter(array &$attachments) {
  $api_settings = \Drupal::config('alshaya_api.settings');

  // We proxy the requests via cloudflare, so we use the current domain as is
  // without any language suffix so HTTP_HOST is enough.
  $attachments['#attached']['drupalSettings']['rcs']['commerceBackend']['baseUrl'] = 'https://' . $_SERVER['HTTP_HOST'];

  // Use proxy on only specific environments.
  if (Settings::get('alshaya_use_proxy', FALSE)) {
    $attachments['#attached']['drupalSettings']['rcs']['commerceBackend']['baseUrl'] = '/proxy/?url=' . $api_settings->get('magento_host');
  }

  // Get the current language, and magento language prefix array,
  // And pass the store header info to use in magento API calls.
  $current_language = \Drupal::languageManager()
    ->getCurrentLanguage()
    ->getId();
  $attachments['#attached']['drupalSettings']['rcs']['commerceBackend']['store'] = $api_settings->get('magento_lang_prefix')[$current_language];
  // Fetch EN store name in case we need to call graphql for EN language,
  // when current language is other than EN.
  if ($current_language !== 'en') {
    $attachments['#attached']['drupalSettings']['rcs']['commerceBackend']['store_en'] = $api_settings->get('magento_lang_prefix')['en'];
  }
}
