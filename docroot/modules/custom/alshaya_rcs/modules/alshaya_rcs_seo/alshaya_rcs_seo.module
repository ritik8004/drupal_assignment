<?php

/**
 * @file
 * Module file for RCS Seo.
 */

/**
 * Implements hook_library_info_alter().
 */
function alshaya_rcs_seo_library_info_alter(&$libraries, $extension) {
  if ($extension !== 'datalayer') {
    return;
  }

  $new_source = '/' . drupal_get_path('module', 'alshaya_rcs_seo') . '/js/datapush.js';
  $options = $libraries['datapush']['js']['js/datapush.js'];
  unset($libraries['datapush']['js']['js/datapush.js']);
  $libraries['datapush']['js'][$new_source] = $options;

  $libraries['datapush']['dependencies'] = [
    'core/jquery',
    'core/drupal',
    'core/drupalSettings',
    'rcs_placeholders/helpers',
    'alshaya_rcs_seo/alshaya_rcs_product_seo',
  ];

  // Load it in the footer as the files which contain the event handlers will
  // be loaded in the footer only.
  unset($libraries['datapush']['header']);
}

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_rcs_seo_page_attachments_alter(&$attachments) {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'alshaya_spc.checkout.confirmation') {
    // This adds the library to the top of the array and above the
    // datalayer/datapush library.
    // If we put the weight=-1 for this, then the library dependencies are
    // loaded later, thus causing issues.
    // Hence we follow this approach.
    array_unshift($attachments['#attached']['library'], 'alshaya_rcs_seo/order_confirmation');
  }
}

/**
 * Implements hook_simple_sitemap_links_alter().
 */
function alshaya_rcs_seo_simple_sitemap_links_alter(array &$links, $sitemap_variant) {
  if ($sitemap_variant === 'default') {
    // Change the sitemap domain based on config value.
    $sitemap_domain = \Drupal::config('alshaya_rcs_seo.settings')->get('sitemap_domain_to_use') ?? 'drupal';
    switch ($sitemap_domain) {
      case 'magento':
        // Prepare the sitemap domain URL.
        $sitemap_domain_url = \Drupal::config('alshaya_api.settings')->get('magento_host');
        break;

      default:
        global $base_url;
        $sitemap_domain_url = $base_url;
        break;
    }

    $variant_links = [];
    $country_code = _alshaya_custom_get_site_level_country_code();
    $url = $sitemap_domain_url . '/media/sitemap/' . strtolower($country_code) . '/sitemap.xml';
    $variant_links[] = [
      'url' => $url,
      'priority' => '0.5',
    ];

    $links = array_merge($variant_links, $links);

    // Unset the image-sitemap from the default sitemap variant.
    $endsWith = '/image-sitemap';
    $len = strlen($endsWith);
    foreach ($links as $key => $value) {
      if (substr($value['url'], -$len) === $endsWith) {
        unset($links[$key]);
      }
    }
  }
}

/**
 * Implements hook_alshaya_rcs_category_query_fields_alter().
 */
function alshaya_rcs_seo_alshaya_rcs_category_query_fields_alter(&$fields) {
  $current_route = \Drupal::routeMatch()->getRouteName();
  if ($current_route === 'alshaya_seo.sitemap') {
    $fields[] = 'description';
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function alshaya_rcs_seo_module_implements_alter(&$implementations, $hook) {
  // To call the alshaya_rcs_seo_rcs_placeholders_graphql_query_alter at the end
  // for RCS Seo specific changes.
  if ($hook == 'rcs_placeholders_graphql_query_alter'
    && isset($implementations['alshaya_rcs_seo'])) {
    $group = $implementations['alshaya_rcs_seo'];
    unset($implementations['alshaya_rcs_seo']);
    $implementations['alshaya_rcs_seo'] = $group;
  }
}

/**
 * Implements hook_rcs_placeholders_graphql_query_alter().
 */
function alshaya_rcs_seo_rcs_placeholders_graphql_query_alter(&$query_fields) {
  // Adding a check for categories just in case if categories doesn't exists.
  if (array_key_exists('categories', $query_fields)) {
    array_push($query_fields['categories']['query']['query($urlKey: [String])']['categories(filters: { url_path: { in: $urlKey }})']['items'], 'gtm_name');
    array_push($query_fields['categories']['query']['query($urlKey: [String])']['categories(filters: { url_path: { in: $urlKey }})']['items']['breadcrumbs'], 'category_gtm_name');
  }
  // Add the GTM attributes for pdp product query as well.
  if (array_key_exists('pdp_product', $query_fields)) {
    array_push($query_fields['pdp_product']['query']['query($url: String)']['products(filter: {url_key: {eq: $url}})']['items']['categories'], 'gtm_name');
    array_push($query_fields['pdp_product']['query']['query($url: String)']['products(filter: {url_key: {eq: $url}})']['items']['categories']['breadcrumbs'], 'category_gtm_name');
  }
  // Get the GTM attributes in single_product_by_color_sku.
  if (array_key_exists('single_product_by_color_sku', $query_fields)) {
    $items = $query_fields['single_product_by_color_sku']['query']['query($sku: String)']['products(filter: {sku: {eq: $sku}})']['items'];
    $items = array_merge($items, [
      'gtm_attributes' => [
        'name',
      ],
    ]);
    $query_fields['single_product_by_color_sku']['query']['query($sku: String)']['products(filter: {sku: {eq: $sku}})']['items'] = $items;
  }
}
