<?php

/**
 * @file
 * Contains general hooks and alters.
 */

use Drupal\field\Entity\FieldConfig;
use Symfony\Component\Yaml\Yaml;

/**
 * Helper function to update / install configs.
 *
 * @param array $configs
 *   The name of configs to import.
 * @param string $module_name
 *   Name of the module, where files resides.
 * @param string $path
 *   Path where configs reside. Defaults to install.
 */
function alshaya_config_install_configs(array $configs, $module_name, $path = 'install') {
  if (empty($configs)) {
    return;
  }

  foreach ($configs as $config) {
    $config_yaml = Yaml::parse(file_get_contents(drupal_get_path('module', $module_name) . '/config/' . $path . '/' . $config . '.yml'));

    // Field config.
    if (strpos($config, 'field.field.') === 0) {
      if ($field_obj = FieldConfig::loadByName($config_yaml['entity_type'], $config_yaml['bundle'], $config_yaml['field_name'])) {
        // Update config using config factory.
        \Drupal::configFactory()
          ->getEditable($config)
          ->setData($config_yaml)
          ->save();

        // Load field config again and save again.
        $field_obj = FieldConfig::loadByName($config_yaml['entity_type'], $config_yaml['bundle'], $config_yaml['field_name']);
        $field_obj->save();
      }
      // Create field config.
      else {
        FieldConfig::create($config_yaml)->save();
      }

      continue;
    }

    // Update config using config factory.
    \Drupal::configFactory()
      ->getEditable($config)
      ->setData($config_yaml)
      ->save();
  }
}

/**
 * Helper function to delete configs.
 *
 * @param array $configs
 *   The name of configs to delete.
 */
function alshaya_config_delete_configs(array $configs) {
  if (empty($configs)) {
    return;
  }

  foreach ($configs as $config) {
    \Drupal::configFactory()->getEditable($config)->delete();
  }
}

/**
 * Scan and return the yml file names inside subdirectory of config of module.
 *
 * @param string $module_name
 *   Module name.
 * @param string $directory
 *   Directory name to scan.
 *
 * @return array
 *   Array of yml file names.
 */
function _alshaya_config_get_config_yml($module_name, $directory) {
  $files = [];
  $directory_path = drupal_get_path('module', $module_name) . '/config/' . $directory;
  // Get all yml files inside the directory.
  $ymls = file_scan_directory($directory_path, '/[(.yml)]$/');
  if (!empty($ymls)) {
    foreach ($ymls as $yml) {
      $files[] = $yml->filename;
    }
  }

  return $files;
}

/**
 * Save the overridden configs of the module.
 *
 * @param string $module_name
 *   Module name.
 */
function _alshaya_config_save_overridden_configs($module_name) {
  foreach (_alshaya_config_get_config_yml($module_name, 'override') as $config_name) {
    if ($config = \Drupal::configFactory()->getEditable($config_name)) {
      $config->save();
    }
  }
}
