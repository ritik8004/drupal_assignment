<?php

/**
 * @file
 * Contains general hooks and alters.
 */

use Drupal\acq_cart\CartInterface;
use Drupal\alshaya_acm_knet\E24PaymentPipe;
use Drupal\Core\Url;
use Symfony\Component\HttpFoundation\RedirectResponse;

/**
 * Implements hook_alshaya_i18n_onetime_translation_add().
 */
function alshaya_acm_knet_alshaya_i18n_onetime_translation_add() {
  // Set K-Net langcode for AR.
  $settings = \Drupal::languageManager()->getLanguageConfigOverride('ar', 'alshaya_acm_knet.settings');
  $settings->set('knet_language_code', 'ARA');
  $settings->save();
}

/**
 * Implements hook_alshaya_acm_checkout_pre_place_order().
 */
function alshaya_acm_knet_alshaya_acm_checkout_pre_place_order(CartInterface $cart) {
  $knet_settings = \Drupal::config('alshaya_acm_knet.settings');

  $temp_store = \Drupal::service('user.private_tempstore')->get('alshaya_acm_checkout');
  $selected_payment = $temp_store->get('selected_payment_method');

  // We want to redirect to K-Net only if payment method is K-Net.
  if ($selected_payment != 'knet') {
    return;
  }

  $order_id = $cart->getExtension('real_reserved_order_id');

  $pipe = new E24PaymentPipe();

  $pipe->setCurrency($knet_settings->get('knet_currency_code'));
  $pipe->setLanguage($knet_settings->get('knet_language_code'));

  $https = (bool) $knet_settings->get('use_secure_response_url');
  $pipe->setResponseUrl(Url::fromRoute('alshaya_acm_knet.response', [], ['absolute' => TRUE, 'https' => $https])->toString());
  $pipe->setErrorUrl(Url::fromRoute('alshaya_acm_knet.error', ['quote_id' => $cart->id()], ['absolute' => TRUE])->toString());

  $totals = $cart->totals();
  $pipe->setAmt($totals['grand']);

  // Set resource path.
  $pipe->setResourcePath($knet_settings->get('resource_path'));

  // Set your alias name here.
  $pipe->setAlias($knet_settings->get('alias'));

  $pipe->setTrackId($order_id);

  $pipe->setUdf1(\Drupal::currentUser()->id());
  $pipe->setUdf2($cart->customerId());
  $pipe->setUdf3($cart->id());
  $pipe->setUdf4($cart->customerEmail());

  // Get results.
  if ($pipe->performPaymentInitialization()) {
    // @TODO: Inform Magento about this info.
    \Drupal::logger('alshaya_acm_knet')->info('Payment id for order id @order_id is @payment_id', [
      '@order_id' => $order_id,
      '@payment_id' => $pipe->getPaymentId(),
    ]);

    $response = new RedirectResponse($pipe->getRedirectUrl());
    $response->send();
    exit;
  }
  else {
    // Log message in watchdog.
    \Drupal::logger('alshaya_acm_knet')->critical($pipe->getErrorMsg());

    // Show generic message to user.
    // @TODO: Confirm this message.
    drupal_set_message(t('Sorry, we are unable to process payments through K-Net. Please use another payment method or contact our customer service team for assistance.'), 'error');

    $response = new RedirectResponse(Url::fromRoute('acq_checkout.form', ['step' => 'payment'])->toString());
    $response->send();
    exit;
  }
}
