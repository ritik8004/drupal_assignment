<?php

/**
 * @file
 * Module file for seo.
 */

use Drupal\alshaya_i18n\AlshayaI18nLanguages;
use Drupal\Core\Url;
use Drupal\acq_sku\Entity\SKU;
use Drupal\file\Entity\File;

/**
 * Implements hook_page_attachments().
 */
function alshaya_seo_page_attachments(array &$attachments) {
  $gkg_config = \Drupal::config('alshaya_seo.google_knowledge_graph');

  $gkg_data = [];

  $gkg_data['@context'] = 'http://schema.org';
  // As checked in current prod, following text is not to be translated.
  $gkg_data['@type'] = 'Organization';
  $gkg_data['name'] = \Drupal::config('system.site')->get('name');
  $gkg_data['url'] = Url::fromRoute('<front>', [], ['absolute' => TRUE])->toString();
  $gkg_data['logo'] = Url::fromUserInput(theme_get_setting('logo.url'), ['absolute' => TRUE])->toString();

  // Add all sameAs links as provided in Config.
  if ($same_as = $gkg_config->get('same_as')) {
    foreach (explode(PHP_EOL, $same_as) as $same_as_link) {
      // Remove \r as well if string contains \r\n.
      $same_as_link = trim($same_as_link, "\r");

      if (!empty($same_as_link)) {
        $gkg_data['sameAs'][] = $same_as_link;
      }
    }
  }

  // Add all contact options. Basic check added to have contact_type set in
  // config to show the whole object.
  if ($gkg_config->get('contact_telephone')) {
    $contact['@type'] = 'ContactPoint';
    $contact['telephone'] = $gkg_config->get('contact_telephone');
    $contact['contactType'] = $gkg_config->get('contact_type');
    $contact['areaServed'] = $gkg_config->get('contact_areaserved');
    $contact['contactOption'] = $gkg_config->get('contact_option');

    // Add all site languages as available language.
    foreach (\Drupal::languageManager()->getLanguages() as $language) {
      $contact['availableLanguage'][] = $language->getName();
    }

    // As required, we want it to be array of objects.
    $gkg_data['contactPoint'][] = $contact;
  }

  // Add/Edit rich snippet for the PDP page.
  $gkg_data = _alshaya_seo_pdp_rich_snippet($gkg_data);

  $attachments['#attached']['html_head']['alshaya_seo'] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'script',
      '#attributes' => [
        'type' => 'application/ld+json',
      ],
      // Adding PHP_EOL on both sides to make it look exactly same as expected.
      '#value' => PHP_EOL . json_encode($gkg_data, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT) . PHP_EOL,
      '#weight' => 100,
    ],
    'gpg',
  ];
}

/**
 * Implements hook_robotstxt().
 */
function alshaya_seo_robotstxt() {
  return [
    'User-agent: *',
    'Disallow: /*.js$',
    'Disallow: /*.css$',
    'Disallow: /*.php$',
    'Disallow: /*?p=*&',
    'Disallow: /*?SID=',
    'Disallow: */index.php/*',
    'Disallow: */catalog/category/view/',
    'Disallow: */catalog/product/view/',
    'Disallow: */catalogsearch/',
  ];
}

/**
 * Implements hook_simple_sitemap_links_alter().
 */
function alshaya_seo_simple_sitemap_links_alter(&$links) {
  foreach ($links as &$link) {
    // We don't want to use langcode but want to use the country code for
    // that language. Altering data here.
    if (isset($link['alternate_urls'])) {
      $alternate_urls = $link['alternate_urls'];

      foreach ($alternate_urls as $language_id => $alternate_url) {
        if ($hreflangcode = AlshayaI18nLanguages::getHrefLangCountry($language_id)) {
          unset($link['alternate_urls'][$language_id]);
          $link['alternate_urls'][$hreflangcode] = $alternate_url;
        }
      }
    }
  }
}

/**
 * Adding google rich snippet to product.
 *
 * @param array $snippet
 *   Rich snippet array.
 *
 * @return array
 *   Rich snippet array.
 */
function _alshaya_seo_pdp_rich_snippet(array $snippet = []) {
  $route_match = \Drupal::routeMatch();
  if ($route_match->getRouteName() == 'entity.node.canonical') {
    /* @var \Drupal\node\Entity\Node $node */
    $node = $route_match->getParameter('node');
    // If 'product' node.
    if ($node && $node->getType() == 'acq_product') {
      if ($sku_field = $node->get('field_skus')) {
        $sku_id = $sku_field->first()->getString();
        $sku_entity = SKU::loadFromSku($sku_id);
        $product_title = "";
        $product_image = "";
        $product_description = "";
        $final_price = "";
        $currency = \Drupal::configFactory()->get('acq_commerce.currency')->get('currency_code');

        // If sku name is available.
        if ($sku_entity->get('name')) {
          $product_title = $sku_entity->get('name')->getString();
        }

        // If sku short description is available.
        if ($sku_entity->get('attr_short_description')) {
          $product_description = $sku_entity->get('attr_short_description')->getValue()[0]['value'];
        }

        // If final price is available.
        if ($sku_entity->get('final_price')) {
          $final_price = (float) $sku_entity->get('final_price')->getString();
        }

        // If sku image is available.
        if ($sku_entity->get('image')) {
          if ($image_id = $sku_entity->get('image')->getValue()[0]['target_id']) {
            if ($image = File::load($image_id)) {
              $product_image = file_create_url($image->getFileUri());
            }
          }
        }

        // Prepare rich snippet.
        $snippet['@type'] = 'Product';
        $snippet['name'] = $product_title;
        $snippet['description'] = $product_description;
        $snippet['image'] = $product_image;
        // @Todo: Change this once brand field is available.
        $snippet['brand'] = [
          '@type' => 'Thing',
          'name' => \Drupal::config('system.site')->get('name'),
        ];
        $snippet['offers'] = [
          '@type' => "Offer",
          'priceCurrency' => $currency,
          'price' => $final_price,
        ];
      }
    }
  }

  return $snippet;
}
