<?php

/**
 * @file
 * Module file for seo transac.
 */

use Drupal\Core\Url;
use Drupal\acq_sku\Entity\SKU;

/**
 * Function to check if we should process GTM code for current request.
 *
 * @return bool
 *   Whether to process or not.
 */
function _alshaya_seo_transac_process_gtm() {
  static $process = NULL;

  if ($process !== NULL) {
    return $process;
  }

  $currentUser = \Drupal::currentUser();
  $current_route_name = \Drupal::routeMatch()->getRouteName();

  // List of route expections with AJAX.
  $whitelisted_routes = [
    'views.ajax',
    'alshaya_acm_product.product_modal',
  ];

  $route_params = \Drupal::routeMatch()->getRawParameters();

  // Disable SEO modifications for non-customer users (admins).
  if ($currentUser->isAuthenticated() && !alshaya_acm_customer_is_customer($currentUser)) {
    $process = FALSE;
  }
  // Don't process for AJAX requests.
  elseif ((stripos(\Drupal::request()->getRequestUri(), 'ajax') > -1) && (!in_array($current_route_name, $whitelisted_routes))) {
    $process = FALSE;
  }
  elseif (!\Drupal::service('router.admin_context')->isAdminRoute()
    || ($current_route_name === 'entity.user.edit_form')) {
    $process = TRUE;
  }
  else {
    // Return false by default.
    $process = FALSE;
  }

  return $process;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function alshaya_seo_transac_preprocess_html(&$variables) {
  if (_alshaya_seo_transac_process_gtm()) {
    /** @var \Drupal\alshaya_seo_transac\AlshayaGtmManager $gtmManager */
    $gtm_manager = \Drupal::service('alshaya_seo_transac.gtm_manager');
    $variables['attributes']['gtm-currency'] = \Drupal::configFactory()->get('acq_commerce.currency')->getRawData()['currency_code'];
    $variables['attributes']['gtm-container'] = $gtm_manager->convertCurrentRouteToGtmPageName($gtm_manager->getGtmContainer());
    $variables['attributes']['gtm-list-name'] = $gtm_manager->convertCurrentRouteToGtmListName($gtm_manager->getGtmContainer());
  }
}

/**
 * Implements hook_page_attachments().
 */
function alshaya_seo_transac_page_attachments(array &$attachments) {
  if (!_alshaya_seo_transac_process_gtm()) {
    return;
  }

  $gkg_config = \Drupal::config('alshaya_seo.google_knowledge_graph');

  $gkg_data = [];

  $gkg_data['@context'] = 'http://schema.org';
  // As checked in current prod, following text is not to be translated.
  $gkg_data['@type'] = 'Organization';
  $gkg_data['name'] = \Drupal::config('system.site')->get('name');
  $gkg_data['url'] = Url::fromRoute('<front>', [], ['absolute' => TRUE])->toString();
  $gkg_data['logo'] = Url::fromUserInput(theme_get_setting('logo.url'), ['absolute' => TRUE])->toString();

  // Add all sameAs links as provided in Config.
  if ($same_as = $gkg_config->get('same_as')) {
    foreach (explode(PHP_EOL, $same_as) as $same_as_link) {
      // Remove \r as well if string contains \r\n.
      $same_as_link = trim($same_as_link, "\r");

      if (!empty($same_as_link)) {
        $gkg_data['sameAs'][] = $same_as_link;
      }
    }
  }

  // Add all contact options. Basic check added to have contact_type set in
  // config to show the whole object.
  if ($gkg_config->get('contact_telephone')) {
    $contact['@type'] = 'ContactPoint';
    $contact['telephone'] = $gkg_config->get('contact_telephone');
    $contact['contactType'] = $gkg_config->get('contact_type');
    $contact['areaServed'] = $gkg_config->get('contact_areaserved');
    $contact['contactOption'] = $gkg_config->get('contact_option');

    // Add all site languages as available language.
    foreach (\Drupal::languageManager()->getLanguages() as $language) {
      $contact['availableLanguage'][] = $language->getName();
    }

    // As required, we want it to be array of objects.
    $gkg_data['contactPoint'][] = $contact;
  }

  // Add/Edit rich snippet for the PDP page.
  $gkg_data = _alshaya_seo_transac_pdp_rich_snippet($gkg_data);

  $attachments['#attached']['html_head']['alshaya_seo'] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'script',
      '#attributes' => [
        'type' => 'application/ld+json',
      ],
      // Adding PHP_EOL on both sides to make it look exactly same as expected.
      '#value' => PHP_EOL . json_encode($gkg_data, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . PHP_EOL,
      '#weight' => 100,
    ],
    'gpg',
  ];
}

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_seo_transac_page_attachments_alter(&$page) {
  if (_alshaya_seo_transac_process_gtm()) {
    $page['#attached']['library'][] = 'alshaya_seo_transac/gtm';
  }
}

/**
 * Implements template_preprocess_node().
 */
function alshaya_seo_transac_preprocess_node(&$variables) {
  if (!_alshaya_seo_transac_process_gtm()) {
    return;
  }

  $view_mode = $variables['view_mode'];
  /** @var \Drupal\node\Entity\Node $entity */
  $entity = $variables['node'];

  if (($entity->bundle() === 'acq_product') &&
    (\Drupal::languageManager()->getCurrentLanguage()->getId() === $entity->language()->getId())) {
    /** @var \Drupal\alshaya_seo_transac\AlshayaGtmManager $alshayaGtmManager */
    $gtm_manager = \Drupal::service('alshaya_seo_transac.gtm_manager');
    $product_node = $gtm_manager->fetchProductGtmAttributes($entity, $view_mode);
    $variables['gtm_attributes']['#markup'] = $gtm_manager->convertAttrsToString($product_node);
  }
}

/**
 * Adding google rich snippet to product.
 *
 * @param array $snippet
 *   Rich snippet array.
 *
 * @return array
 *   Rich snippet array.
 */
function _alshaya_seo_transac_pdp_rich_snippet(array $snippet = []) {
  $route_match = \Drupal::routeMatch();
  if ($route_match->getRouteName() == 'entity.node.canonical') {
    /* @var \Drupal\node\Entity\Node $node */
    $node = $route_match->getParameter('node');
    // If 'product' node.
    if ($node && $node->getType() == 'acq_product') {
      if ($sku_field = $node->get('field_skus')) {
        $sku_id = $sku_field->first()->getString();
        $sku_entity = SKU::loadFromSku($sku_id);
        $product_title = "";

        // Including the utility file.
        \Drupal::moduleHandler()->loadInclude('alshaya_acm_product', 'inc', 'alshaya_acm_product.utility');
        $product_image = _alshaya_acm_get_product_display_image_url($sku_entity);

        $product_description = _alshaya_seo_get_node_meta_description();
        $final_price = "";
        $currency = \Drupal::configFactory()->get('acq_commerce.currency')->get('currency_code');

        // If sku name is available.
        if ($sku_entity->get('name')) {
          $product_title = $sku_entity->get('name')->getString();
        }

        // If final price is available.
        if ($sku_entity->get('final_price')) {
          $final_price = (float) $sku_entity->get('final_price')->getString();
        }

        // Prepare rich snippet.
        $snippet['@type'] = 'Product';
        $snippet['name'] = $product_title;
        $snippet['description'] = $product_description;
        $snippet['image'] = $product_image;
        // @Todo: Change this once brand field is available.
        $snippet['brand'] = [
          '@type' => 'Thing',
          'name' => \Drupal::config('system.site')->get('name'),
        ];
        $snippet['offers'] = [
          '@type' => "Offer",
          'priceCurrency' => $currency,
          'price' => $final_price,
        ];
      }
    }
  }

  return $snippet;
}

/**
 * Implements hook_datalayer_alter().
 */
function alshaya_seo_transac_datalayer_alter(&$data_layer) {
  if (!_alshaya_seo_transac_process_gtm()) {
    return;
  }

  /** @var \Drupal\alshaya_seo_transac\AlshayaGtmManager $gtm_manager */
  $gtm_manager = \Drupal::service('alshaya_seo_transac.gtm_manager');
  $currency_code = \Drupal::configFactory()->get('acq_commerce.currency')->getRawData()['currency_code'];

  try {
    $current_route = $gtm_manager->getGtmContainer();
    $general_dl_attributes = $gtm_manager->fetchGeneralPageAttributes($data_layer);

    // Preserve attributes before overriding the datalayer attributes.
    if (isset($data_layer['deliveryCity'])) {
      unset($data_layer['deliveryCity']);
    }

    if (isset($data_layer['deliveryArea'])) {
      $general_dl_attributes['deliveryArea'] = $data_layer['deliveryArea'];
    }

    $data_layer = $general_dl_attributes;

    $page_type = $gtm_manager->convertCurrentRouteToGtmPageName($gtm_manager->getGtmContainer());
    switch ($current_route['route_name']) {
      case 'entity.node.canonical':
        if (isset($current_route['route_params'], $current_route['route_params']['node'])) {
          /** @var \Drupal\node\Entity\Node $node */
          $node = $current_route['route_params']['node'];
          if ($node->bundle() === 'acq_product') {
            $attributes = $gtm_manager->fetchProductGtmAttributes($node, 'full');
            $processed_attributes = $gtm_manager->processAttributesForPdp($attributes);
            $data_layer = array_merge($data_layer, $processed_attributes);
            $data_layer['pageType'] = $gtm_manager->convertCurrentRouteToGtmPageName($gtm_manager->getGtmContainer());
          }
        }
        break;

      case 'acq_checkout.form':
        if (in_array($current_route['route_params']['step'],
          ['login', 'delivery', 'payment'], TRUE)) {

          $cart_item_attributes = $gtm_manager->fetchCartItemAttributes();

          $products = [];
          $data_layer['privilegeOrder'] = $cart_item_attributes['privilegeOrder'];
          $data_layer['privilegesCardNumber'] = $cart_item_attributes['privilegesCardNumber'];
          $step = isset($cart_item_attributes['step']) ? $cart_item_attributes['step'] : NULL;
          unset($cart_item_attributes['privilegeOrder'], $cart_item_attributes['privilegesCardNumber'], $cart_item_attributes['step']);

          foreach ($cart_item_attributes as $key => $cart_item) {
            $product = $gtm_manager->convertHtmlAttributesToDatalayer($cart_item);
            $product['quantity'] = $cart_item['quantity'];
            $products[] = $product;
          }

          // Set the correct step id.
          switch ($current_route['route_params']['step']) {
            case 'login':
              $step = 1;
              break;

            case 'delivery':
              $step = !empty($step) ? $step : 2;
              break;

            case 'payment':
              $step = 4;
              break;
          }

          $data_layer_cart = [
            'ecommerce' => [
              'currencyCode' => $currency_code,
              'checkout' => [
                'actionField' => [
                  'step' => $step,
                ],
                'products' => $products,
              ],
            ],
          ];

          $data_layer = array_merge($data_layer, $data_layer_cart);

        }
        elseif (in_array($current_route['route_params']['step'], ['confirmation'], TRUE)) {
          $order = _alshaya_acm_checkout_get_last_order_from_session();

          // We check if we have valid order id.
          if (empty($order)) {
            return;
          }

          $cookie_key = 'alshaya_gtm_confirmation_visited_' . $order['order_id'];

          $already_visited = (int) \Drupal::request()->cookies->get('Drupal_visitor_' . $cookie_key);

          // Send order complete confirmation to GTM only once.
          if ($already_visited !== 1) {
            $attributes = $gtm_manager->fetchCompletedOrderAttributes($order);
            $data_layer = array_merge($data_layer, $attributes['general']);

            $data_layer['privilegeOrder'] = $attributes['previlegeOrder'] ? 'order with privilege club' : 'order without privilege club';

            $data_layer['ecommerce'] = [
              'currencyCode' => $currency_code,
              'purchase' => [
                'actionField' => $attributes['actionField'],
                'products' => $attributes['products'],
              ],
            ];

            /** @var \Drupal\alshaya_acm_checkout\CheckoutOptionsManager $checkout_options_manager */
            $checkout_options_manager = \Drupal::service('alshaya_acm_checkout.options_manager');
            if ($attributes['general']['deliveryOption'] === $checkout_options_manager->getClickandColectShippingMethod()) {
              $data_layer['event'] = 'VirtualPageView';
              $data_layer['virtualPageUrl'] = '/virtualpv/click-and-collect/step4/order-success';
              $data_layer['virtualPageTitle'] = 'C&C Step 4 â€“ Order Success';
            }

            user_cookie_save([$cookie_key => 1]);
          }
        }

        break;
    }

    // Generic handling of page type for user pages.
    if ($page_type === 'not defined') {
      $current_route = $gtm_manager->getGtmContainer();
      $current_path = $current_route['pathinfo']->getpath();
      if (preg_match('/^\/user\/{user}\/(\S*)$/', $current_path, $matches)) {
        if (strpos($matches[1], '{') === 0) {
          $route_param_identifier = trim($matches[1], '{}');
          $route_param_val = $current_route['route_params'][$route_param_identifier]->id();
          $matches[1] = $route_param_val;
        }
        $page_type = 'user-' . $matches[1];
      }
    }

    $data_layer['pageType'] = $page_type;
    $page_dl_attributes = $gtm_manager->fetchPageSpecificAttributes($page_type, $current_route);
    $data_layer = array_merge($data_layer, $page_dl_attributes);
  }
  catch (Exception $e) {
    \Drupal::logger('alshaya_seo')->error('Error while fetching GTM attributes: @message', ['@message' => $e->getMessage()]);
  }
}

/**
 * Implements template_preprocess_alshaya_cart_product_name().
 */
function alshaya_seo_transac_preprocess_alshaya_cart_product_name(&$variables) {
  \Drupal::moduleHandler()->loadInclude('alshaya_acm_product', 'inc', 'alshaya_acm_product.utility');
  if (empty($variables['item_code'])) {
    return;
  }

  /** @var \Drupal\alshaya_seo_transac\AlshayaGtmManager $gtmManager */
  $gtm_manager = \Drupal::service('alshaya_seo_transac.gtm_manager');

  $sku_attributes = $gtm_manager->fetchSkuAtttributes($variables['item_code']);

  // Fetch product for this sku to get the category.
  $product_node = alshaya_acm_product_get_display_node($variables['item_code']);

  $sku_attributes['gtm-category'] = implode('/', $gtm_manager->fetchProductCategories($product_node));
  $sku_attributes['gtm-main-sku'] = $product_node->get('field_skus')->first()->getString();
  $sku_attributes['gtm-type'] = 'gtm-remove-cart-wrapper';
  $sku_attributes['gtm-size'] = isset($variables['sku_attributes'], $variables['sku_attributes']['attr_size']) ? $variables['sku_attributes']['attr_size']['value'] : '';

  $variables['gtm_attributes']['#markup'] = $gtm_manager->convertAttrsToString($sku_attributes);
}

/**
 * Implements hook_user_login().
 */
function alshaya_seo_transac_user_login($account) {
  user_cookie_save(['alshaya_gtm_user_logged_in' => $account->id()]);
}

/**
 * Implements hook_user_logout().
 */
function alshaya_seo_transac_user_logout($account) {
  user_cookie_save(['alshaya_gtm_user_logged_out' => $account->id()]);
}
