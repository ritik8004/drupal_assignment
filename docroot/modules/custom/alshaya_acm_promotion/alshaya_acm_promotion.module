<?php

/**
 * @file
 * Contains general hooks and alters.
 */

use Drupal\acq_commerce\SKUInterface;
use Drupal\acq_cart\CartInterface;
use Drupal\acq_sku\Entity\SKU;
use Drupal\alshaya_acm_promotion\Form\SelectFreeGiftForm;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormState;
use Drupal\Core\Url;
use Drupal\node\Entity\Node;
use Drupal\node\NodeInterface;
use Drupal\Component\Utility\Html;

/**
 * Implements hook_views_data_alter().
 */
function alshaya_acm_promotion_views_data_alter(array &$data) {
  $data['search_api_index_product']['field_skus']['argument']['id'] = 'alshaya_sku_ignore_whitespaces';
}

/**
 * Implements hook_theme().
 */
function alshaya_acm_promotion_theme($existing, $type, $theme, $path) {
  $items = [];

  $items['cart_top_promotions'] = [
    'variables' => [
      'promotions' => NULL,
      'free_shipping' => NULL,
      'inactive_promotions' => NULL,
      'active_promotions' => NULL,
    ],
  ];

  $items['free_gift_promotions'] = [
    'variables' => [
      'free_sku_entity_id' => NULL,
      'free_sku_code' => NULL,
      'free_sku_title' => NULL,
      'promo_title' => NULL,
      'sku_image' => NULL,
      'promo_code' => NULL,
    ],
  ];

  $items['free_gift_cart_label'] = [
    'variables' => [
      'promos' => NULL,
    ],
  ];

  $items['free_gift_promotion_list'] = [
    'variables' => [
      'message' => NULL,
      'coupon' => NULL,
      'image' => NULL,
      'title' => NULL,
    ],
  ];

  $items['free_gift_item'] = [
    'variables' => [
      'title' => NULL,
      'image' => NULL,
      'url' => NULL,
      'select_link' => NULL,
    ],
  ];

  return $items;
}

/**
 * Implements hook_theme_registry_alter().
 */
function alshaya_acm_promotion_theme_registry_alter(&$theme_registry) {
  $theme_registry['acq_commerce_price']['variables']['promotions'] = NULL;
  $theme_registry['acq_commerce_price']['variables']['final_price'] = NULL;
  $theme_registry['acq_commerce_price']['variables']['discount'] = NULL;
}

/**
 * Implements hook_acq_promotion_promotion_node_alter().
 */
function alshaya_acm_promotion_acq_promotion_promotion_node_alter(Node $node, array $promotion) {
  // Set the Promotion subtype.
  $node->get('field_alshaya_promotion_subtype')
    ->setValue(\Drupal::service('alshaya_acm_promotion.manager')
      ->getSubType($promotion));

  // Set free skus for promotions.
  if (!empty($promotion['free_gift_products'])) {
    $node->get('field_free_gift_skus')->setValue($promotion['free_gift_products']);
  }
}

/**
 * Implements hook_acq_promotion_data_alter().
 */
function alshaya_acm_promotion_acq_promotion_data_alter(&$promotion) {
  $promotion['free_gift_products'] = [];

  // Conductor api version.
  $middleware_version = \Drupal::config('acq_commerce.conductor')->get('api_version');
  // @Todo: remove it when we using v2 for all.
  $extension_key = $middleware_version == 'v2' ? 'extension' : 'extension_attributes';

  // Extract free gift skus & remove them from list of products to be processed
  // for this promotion.
  foreach ($promotion['products'] as $key => $product) {
    if (!empty($product[$extension_key])
      && !empty($product[$extension_key]['ampromo_cart_sku'])
      && ($product[$extension_key]['ampromo_cart_sku'])) {
      $promotion['free_gift_products'][] = $product['product_sku'];
      unset($promotion['products'][$key]);
    }
  }
}

/**
 * Implements hook_acq_sku_base_fields_updated().
 */
function alshaya_acm_promotion_acq_sku_base_fields_updated(array $fields, $op = 'add') {
  /** @var \Drupal\alshaya_search_api\AlshayaSearchApiFacetsManager $facet_manager */
  $facet_manager = \Drupal::service('alshaya_search_api.facets_manager');

  $facet_source_id = 'search_api:views_block__alshaya_product_list__block_2';
  $filter_bar_id = 'facets_summary.facets_summary.filter_bar_promotions';
  $prefix = 'promo';

  switch ($op) {
    case 'add':
      foreach ($fields as $field_code => $field) {
        if (empty($field['facet'])) {
          // We use add even when resetting. Remove facet if available.
          $facet_manager->removeFacet($field_code, $filter_bar_id, $prefix);
          continue;
        }

        $facet_manager->createFacet($field_code, $facet_source_id, $filter_bar_id, $prefix, ['name' => $field['label']]);
      }
      break;

    case 'remove':
      foreach ($fields as $field_code => $field) {
        // Remove from facets if facet is 1.
        if (!empty($field['facet'])) {
          $facet_manager->removeFacet($field_code, $filter_bar_id, $prefix);
        }
      }
      break;
  }
}

/**
 * Implements hook_alshaya_acm_get_remove_from_basket_link_alter().
 */
function alshaya_acm_promotion_alshaya_acm_get_remove_from_basket_link_alter(&$remove_url, CartInterface $cart, SKUInterface $sku) {
  // If for any reason we set it to empty value in any other alter
  // implementation, we don't want to modify again.
  if (empty($remove_url)) {
    return;
  }

  // We need to modify here only if there are rules applied in cart.
  $rules_applied = $cart->get('cart_rules');
  if (empty($rules_applied)) {
    return;
  }

  /** @var \Drupal\alshaya_acm_promotion\AlshayaPromotionsManager $manager */
  $manager = \Drupal::service('alshaya_acm_promotion.manager');

  $coupon = $cart->getCoupon();

  foreach ($rules_applied as $rule_id) {
    $promotion = $manager->getPromotionByRuleId($rule_id);

    if (!($promotion instanceof NodeInterface)) {
      continue;
    }

    $free_skus = $manager->getFreeSkusByRuleId($rule_id);

    $sku_string = $sku->getSku();
    $is_free_sku_item = FALSE;

    if (in_array($sku_string, $free_skus)) {
      $is_free_sku_item = TRUE;
    }
    else {
      /** @var \Drupal\alshaya_acm_product\SkuManager $skuManager */
      $skuManager = \Drupal::service('alshaya_acm_product.skumanager');
      $parent = $skuManager->getParentSkuBySku($sku_string);
      if ($parent instanceof SKU && in_array($parent->getSku(), $free_skus)) {
        $is_free_sku_item = TRUE;
      }
    }

    if ($is_free_sku_item) {
      if ($coupon && $promotion->get('field_coupon_code')->getString() == $coupon) {
        // For coupon based promotions we want to allow removal.
        // But we need to remove the coupon as well.
        $remove_url->setRouteParameter('coupon', 'remove');
      }
      else {
        // For non-coupon based free gifts, we don't want to allow removal
        // for now.
        $remove_url = NULL;
      }
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function alshaya_acm_promotion_node_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  // Need processing only for products.
  if ($entity->bundle() != 'acq_product') {
    return;
  }

  // Return early for unknown view modes.
  if (!in_array($view_mode, [
    'modal',
    'full',
    'teaser',
    'product_category_carousel',
  ])
  ) {
    return;
  }

  /** @var \Drupal\alshaya_acm_product\SkuManager $skuManager */
  $skuManager = \Drupal::service('alshaya_acm_product.skumanager');
  /** @var \Drupal\alshaya_acm_promotion\AlshayaPromoLabelManager $promoLabelManager */
  $promoLabelManager = \Drupal::service('alshaya_acm_promotion.label_manager');

  $sku = $skuManager->getSkuForNode($entity);

  // Sanity check.
  // We add logs for such faulty data either in ACM or in alshaya_acm_product.
  if (empty($sku)) {
    return;
  }

  $sku_entity = SKU::loadFromSku($sku);

  // Sanity check.
  // We add logs for such faulty data either in ACM or in alshaya_acm_product.
  if (!($sku_entity instanceof SKUInterface)) {
    return;
  }

  $promotion_label = $promoLabelManager->getPromotionLabelForProductDetail($sku_entity, $view_mode);

  if (!empty($promotion_label['promotions'])) {
    $build['promotions'] = $promotion_label['promotions'];
  }

  if (!empty($promotion_label['free_gift_promotions'])) {
    $build['free_gift_promotions'] = $promotion_label['free_gift_promotions'];
  }
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function alshaya_acm_promotion_acq_sku_view(array &$build,
                                            EntityInterface $entity,
                                            EntityViewDisplayInterface $display,
                                            $view_mode) {
  if ($view_mode != 'free_gift') {
    return;
  }

  // Disable the default add to cart form.
  $build['#no_add_to_cart'] = TRUE;

  /** @var \Drupal\alshaya_acm_product\SkuManager $skuManager */
  $skuManager = \Drupal::service('alshaya_acm_product.skumanager');

  /** @var \Drupal\alshaya_acm_product\SkuImagesManager $skuImagesManager */
  $skuImagesManager = \Drupal::service('alshaya_acm_product.sku_images_manager');

  /** @var \Drupal\alshaya_acm_promotion\AlshayaPromotionsManager $promotionsManager */
  $promotionsManager = \Drupal::service('alshaya_acm_promotion.manager');

  $pdp_layout = $skuManager->getPdpLayout($entity, 'modal');
  try {
    $skuForGallery = $promotionsManager->getSkuForFreeGiftGallery($entity);
    $build['gallery'] = $skuImagesManager->getGallery($skuForGallery, $pdp_layout);
  }
  catch (\Exception $e) {
    $build['gallery'] = [];
  }

  $build['price_block']['#markup'] = '<div class="free-price-markup">' . t('FREE') . '</div>';
  $build['item_code']['#markup'] = $entity->getSku();

  \Drupal::moduleHandler()->loadInclude('alshaya_acm_product', 'inc', 'alshaya_acm_product.utility');
  $build['brand_logo'] = alshaya_acm_product_get_brand_logo($entity);

  // Add PDP slider position config to drupalSettings so we can use it in JS.
  $build['#attached']['drupalSettings']['alshaya_white_label']['image_slider_position_pdp'] = 'slider-position-' . $skuManager->getImageSliderPosition($entity);
  $build['image_slider_position_pdp']['#markup'] = 'slider-position-' . Html::cleanCssIdentifier($skuManager->getImageSliderPosition($entity));

  // Add PDP slider position config to variable so it is available in themes.
  $build['#attached']['drupalSettings']['pdp_slider_items'] = \Drupal::config('alshaya_acm_product.settings')->get('pdp_slider_items_settings.pdp_slider_items_number');

  $coupon = \Drupal::request()->get('coupon') ?? '';
  $promotion_id = \Drupal::request()->get('promotion_id') ?? NULL;
  $back = \Drupal::request()->get('back') ?? NULL;
  if (!empty($back)) {
    $build['back_to_collection'] = [
      '#type' => 'link',
      '#title' => t('Back to Collection'),
      '#url' => Url::fromRoute('alshaya_acm_promotion.free_gifts_list',
        [
          'node' => $promotion_id,
          'js' => 'nojs',
        ],
        [
          'attributes' => [
            'class' => ['use-ajax'],
          ],
          'query' => [
            'replace' => 1,
            'coupon' => $coupon,
          ],
        ]
      ),
    ];
  }

  $form_state = new FormState();
  $form_state->setStorage([
    'coupon' => $coupon ?? '',
    'sku' => $entity->getSku(),
    'promotion_id' => $promotion_id ?? '',
  ]);

  $build['select_free_gift'] = \Drupal::formBuilder()->buildForm(
    SelectFreeGiftForm::class,
    $form_state
  );
}

/**
 * Implements hook_sku_variant_info_alter().
 */
function alshaya_acm_promotion_sku_variant_info_alter(array &$variant, SKUInterface $child, ?SKUInterface $parent) {
  /** @var \Drupal\alshaya_acm_promotion\AlshayaPromoLabelManager $promoLabelManager */
  $promoLabelManager = \Drupal::service('alshaya_acm_promotion.label_manager');
  $variant['promotionsRaw'] = $promoLabelManager->getPromotionLabelForProductDetail($child, 'api');
  $variant['freeGiftPromotion'] = $promoLabelManager->getPromotionLabelForProductDetail($child, 'free_gift');
}

/**
 * Implements hook_sku_product_info_alter().
 */
function alshaya_acm_promotion_sku_product_info_alter(array &$product_info, SKUInterface $sku) {
  /** @var \Drupal\alshaya_acm_promotion\AlshayaPromoLabelManager $promoLabelManager */
  $promoLabelManager = \Drupal::service('alshaya_acm_promotion.label_manager');
  $product_info['promotionsRaw'] = $promoLabelManager->getPromotionLabelForProductDetail($sku, 'api');
  $product_info['freeGiftPromotion'] = $promoLabelManager->getPromotionLabelForProductDetail($sku, 'free_gift');
}
