<?php

/**
 * @file
 * Module file.
 */

use Drupal\alshaya_performance\Logger\AlshayaPerformanceSysLog;
use Drupal\Core\Cache\Cache;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Site\Settings;

/**
 * Implements hook_views_plugins_cache_alter().
 */
function alshaya_performance_views_plugins_cache_alter(array &$plugins) {
  // Use custom alshaya cache plugin to avoid adding list cache tag.
  if (isset($plugins['tag']) && isset($plugins['alshaya_tag'])) {
    $plugins['tag']['class'] = $plugins['alshaya_tag']['class'];
  }

  if (isset($plugins['search_api_tag']) && isset($plugins['alshaya_search_api_tag'])) {
    $plugins['search_api_tag']['class'] = $plugins['alshaya_search_api_tag']['class'];
  }
}

/**
 * Implements hook_ENTITY_TYPE_view_alter().
 */
function alshaya_performance_node_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  $build['#cache']['tags'][] = 'node_type:' . $entity->bundle();
}

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function alshaya_performance_node_presave(EntityInterface $entity) {
  // Allows for clearing of blocks based on node type.
  // Used for mega menu block.
  $tags = ['node_type:' . $entity->getType()];
  Cache::invalidateTags($tags);
}

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function alshaya_performance_taxonomy_term_presave(EntityInterface $entity) {
  // Used for address book area list.
  Cache::invalidateTags(['taxonomy_term:' . $entity->bundle()]);
}

/**
 * Implements hook_ENTITY_TYPE_delete().
 */
function alshaya_performance_taxonomy_term_delete(EntityInterface $entity) {
  // Used for address book area list.
  Cache::invalidateTags(['taxonomy_term:' . $entity->bundle()]);
}

/**
 * Helper function to set log mode from settings.
 */
function alshaya_performance_reset_log_mode() {
  $mode = Settings::get('alshaya_performance_log_mode');

  // By default set it to production mode.
  if (empty($mode)) {
    $mode = AlshayaPerformanceSysLog::ALSHAYA_PERFORMANCE_PRODUCTION_MODE;
  }

  $config = \Drupal::configFactory()->getEditable('alshaya_performance.settings');
  $config->set('mode', $mode);
  $config->save();
}

/**
 * Lighter version of drupal_flush_all_caches() function.
 *
 * This function clears frontend caches (css, js and twig) only.
 *
 * @see drupal_flush_all_caches()
 */
function alshaya_performance_flush_frontend_caches() {
  // Frontend data can remain in the rendered bins, so we need to empty them
  // as well.
  Cache::invalidateTags(['rendered']);

  // Frontend data can remain in these bins, so we need to empty them as well.
  foreach (Cache::getBins() as $cache_backend) {
    $cache_backend->deleteAll();
  }

  // Flush asset file caches.
  \Drupal::service('asset.css.collection_optimizer')->deleteAll();
  \Drupal::service('asset.js.collection_optimizer')->deleteAll();
  _drupal_flush_css_js();

  // Wipe the Twig PHP Storage cache.
  \Drupal::service('twig')->invalidate();

}

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_performance_page_attachments_alter(array &$attachments) {
  $preload = [];

  \Drupal::moduleHandler()->alter('alshaya_performance_preload', $preload);
  \Drupal::theme()->alter('alshaya_performance_preload', $preload);

  foreach ($preload ?? [] as $index => $item) {
    $attachments['#attached']['html_head'][$item] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'link',
        '#attributes' => [
          'rel' => 'preload',
          'href' => $item,
        ],
      ],
      'alshaya_performance_preload_' . $index,
    ];
  }
}
