<?php

/**
 * @file
 * Contains general hooks and alters.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\acq_sku\Entity\SKU;

/**
 * Implements hook_page_attachments().
 */
function alshaya_product_lpn_page_attachments(array &$page) {
  $config = \Drupal::config('alshaya_product_lpn.settings');
  $lpn_attribute = $config->get('lpn_attribute')
    ? 'attr_' . $config->get('lpn_attribute')
    : '';

  $page['#attached']['drupalSettings']['lpn'] = [
    'lpn_attribute' => $lpn_attribute,
  ];
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function alshaya_product_lpn_form_sku_base_form_alter(&$form, FormStateInterface $form_state) {
  // Get lpn_attribute id from config.
  $lpn_attribute = \Drupal::config('alshaya_product_lpn.settings')->get('lpn_attribute') ?? '';

  // Hide the LPN attribute.
  if (!empty($lpn_attribute) && isset($form['ajax']['configurables'][$lpn_attribute])) {
    $form['ajax']['configurables'][$lpn_attribute]['#prefix'] = '<div class="hidden">';
    $form['ajax']['configurables'][$lpn_attribute]['#suffix'] = '</div>';
    $form['ajax']['configurables'][$lpn_attribute]['#weight'] = 999;
  }
}

/**
 * Implements hook_acq_sku_configurable_variants_alter().
 *
 * Remove the child product having all same attributes but
 * belongs to new season to ensure old season products are sold first.
 */
function alshaya_product_lpn_acq_sku_configurable_variants_alter(array &$children, SKU $sku) {
  // Get lpn_attribute id from config.
  $lpn_attribute = \Drupal::config('alshaya_product_lpn.settings')->get('lpn_attribute') ?? '';
  $child_group = [];

  if (empty($lpn_attribute)) {
    return;
  }

  $configurations = unserialize($sku->get('field_configurable_attributes')->getString());
  $configurable_attribute_codes = array_column($configurations, 'code', 'code');
  $season_codes = [];
  foreach ($configurations as $configuration) {
    if ($lpn_attribute == $configuration['code']) {
      foreach ($configuration['values'] as $value) {
        $season_codes[$value['value_id']] = $value['label'];
      }
    }
  }

  // Do not process further if we don't have lpn_attribute as
  // configurable_attribute for the product.
  if (!in_array($lpn_attribute, $configurable_attribute_codes)) {
    return;
  }

  foreach ($children as $child_sku => $child) {
    $attributes = $child->get('attributes')->getValue();
    $attributes = array_column($attributes, 'value', 'key');
    $season_code = '';

    foreach ($configurable_attribute_codes as $attribute_id) {
      if ($attribute_id === $lpn_attribute) {
        $season_code = isset($attributes[$attribute_id]) ? $attributes[$attribute_id] : '';
        continue;
      }
      $children_with_attr[$attribute_id] = $attributes[$attribute_id];
    }

    if (empty($season_code)) {
      continue;
    }

    $attributes_key = implode('-', $children_with_attr);

    if (array_key_exists($attributes_key, $child_group)) {
      if (_alshaya_product_lpn_compare_season_codes($season_codes, $child_group[$attributes_key][$lpn_attribute], $season_code)) {
        // If current product's season_code is smaller than another child's
        // season code and both have same configurable attributes, then
        // remove the product with higher season code.
        unset($children[$child_group[$attributes_key]['sku']]);
        $child_group[$attributes_key] = [
          'sku' => $child_sku,
          $lpn_attribute => $season_code,
        ];
      }
      else {
        // If current product's season_code is greater than another child's
        // season code and both have same configurable attributes, then
        // remove the current product.
        unset($children[$child_sku]);
      }
    }
    else {
      $child_group[$attributes_key] = [
        'sku' => $child_sku,
        $lpn_attribute => $season_code,
      ];
    }
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function alshaya_product_lpn_module_implements_alter(&$implementations, $hook) {
  // Call the alshaya_product_lpn_acq_sku_configurable_variants_alter at end.
  if ($hook === 'acq_sku_configurable_variants_alter') {
    $group = $implementations['alshaya_product_lpn'];
    unset($implementations['alshaya_product_lpn']);
    $implementations['alshaya_product_lpn'] = $group;
  }
}

/**
 * Compare Season code 1 and 2 value.
 *
 * @param array $season_codes
 *   Season codes value_id, value array.
 * @param string $code_id_1
 *   Season code 1 value id.
 * @param string $code_id_2
 *   Season code 2 value id.
 *
 * @return bool
 *   Comparison season_code1, season_code2 true or false.
 */
function _alshaya_product_lpn_compare_season_codes(array $season_codes, $code_id_1, $code_id_2) {
  // Get Season code value from value id.
  $season_code1 = $season_codes[$code_id_1];
  $season_code2 = $season_codes[$code_id_2];

  // Split code to get year for each code.
  $season_code1_year = substr($season_code1, 0, 2);
  $season_code2_year = substr($season_code2, 0, 2);

  $flag = FALSE;

  // If season code 1 year > season code 2 year
  // then season code 2 will shown.
  if ($season_code1_year > $season_code2_year) {
    $flag = TRUE;
  }
  elseif ($season_code2_year > $season_code1_year) {
    // Season code 1 will shown.
    $flag = FALSE;
  }

  if ($season_code1_year == $season_code2_year) {
    // Get season code digit for each code.
    $season_code1_digit = $season_code1[strlen($season_code1) - 1] == 0 ? 10 : $season_code1[strlen($season_code1) - 1];
    $season_code2_digit = $season_code2[strlen($season_code2) - 1] == 0 ? 10 : $season_code2[strlen($season_code2) - 1];

    // If season code 1 digit > season code 2 digit
    // then season code 2 will be shown.
    if ($season_code1_digit > $season_code2_digit) {
      $flag = TRUE;
    }
    elseif ($season_code2_digit > $season_code1_digit) {
      // Season code 1 will be shown.
      $flag = FALSE;
    }
    else {
      // If both digit are same then season code 1 will shown.
      $flag = FALSE;
    }
  }

  return $flag;
}
