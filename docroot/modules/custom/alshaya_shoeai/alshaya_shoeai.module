<?php

/**
 * @file
 * File for shoe AI Implementation.
 */

use Drupal\Core\Cache\Cache;

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_shoeai_page_attachments_alter(array &$page) {
  $shop_id = NULL;
  $alshaya_shoeai_settings = \Drupal::config('alshaya_shoeai.settings');
  $page['#cache']['tags'] = Cache::mergeTags($page['#cache']['tags'] ?? [], $alshaya_shoeai_settings->getCacheTags());
  $shoeAi = \Drupal::service('alshaya_shoeai.settings');
  if (is_object($shoeAi)) {
    if ($shoeAi->isShoeAiFeatureEnabled() && (is_pdp_page() || is_plp_page())) {
      $page['#attached']['drupalSettings']['shoeai']['status'] = 'enabled';
      $shop_id = $alshaya_shoeai_settings->get('shop_id') ?: '';
      if ($shop_id != '') {
        $page['#attached']['drupalSettings']['shoeai']['shopId'] = $shop_id;
      }
      $page['#attached']['drupalSettings']['shoeai']['scale'] = 'eu';
      $current_user = \Drupal::currentUser();
      // If user is anonymous.
      $page['#attached']['drupalSettings']['shoeai']['zeroHash'] = '';
      if ($current_user->isAuthenticated()) {
        $page['#attached']['drupalSettings']['shoeai']['zeroHash'] = md5($current_user->getEmail());
      }
      $page['#attached']['library'][] = 'alshaya_shoeai/shoeai_js';
    }
  }
}

/**
 * Function for checking if PDP.
 */
function is_pdp_page() {
  $isProduct = FALSE;
  $node = \Drupal::routeMatch()->getParameter('node');
  if (is_object($node) && $node->bundle() == 'acq_product') {
    $isProduct = TRUE;
  }
  return $isProduct;
}

/**
 * Function for checking if PLP.
 */
function is_plp_page() {
  $isListingPage = FALSE;
  $term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if (is_object($term) && $term->bundle() == 'acq_product_category') {
    $isListingPage = TRUE;
  }
  return $isListingPage;
}
