<?php

/**
 * @file
 * File for shoe AI configuration.
 */

use Drupal\Core\Cache\Cache;

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_shoeai_page_attachments_alter(array &$page) {
  $alshaya_shoeai_settings = \Drupal::config('alshaya_shoeai.settings');
  $page['#cache']['tags'] = Cache::mergeTags($page['#cache']['tags'] ?? [], $alshaya_shoeai_settings->getCacheTags());
  $shoeAi = \Drupal::service('alshaya_shoeai.settings');
  if (is_object($shoeAi)) {
    if ($shoeAi->isShoeAiFeatureEnabled() == TRUE && (is_pdp_page() == TRUE || is_plp_page() == TRUE)) {
      $page['#attached']['drupalSettings']['shoeai']['status'] = 'enabled';
      $page['#attached']['drupalSettings']['shoeai']['shopId'] = $shoeAi->get('shop_id');
      $page['#attached']['drupalSettings']['shoeai']['scale'] = 'eu';
      $current_user = \Drupal::currentUser();
      // If user is anonymous.
      $page['#attached']['drupalSettings']['shoeai']['zeroHash'] = '';
      if ($current_user->isAuthenticated()) {
        $page['#attached']['drupalSettings']['shoeai']['zeroHash'] = md5($current_user->getEmail());
      }
      $page['#attached']['library'][] = 'alshaya_shoeai/shoeai_js';
    }
  }
}

/**
 * Function to check if shoeAi is enabled.
 */
function is_shoe_ai_feature_enabled() {
  $shoe_ai_enabled = FALSE;
  $alshaya_shoeai_settings = \Drupal::config('alshaya_shoeai.settings');
  $state = $alshaya_shoeai_settings->get('enable_shoeai');
  if ($state) {
    $shoe_ai_enabled = TRUE;
  }
  return $shoe_ai_enabled;
}

/**
 * Function for checking if PDP.
 */
function is_pdp_page() {
  $isProduct = FALSE;
  $node = \Drupal::routeMatch()->getParameter('node');
  if (is_object($node) && $node->bundle() == 'acq_product') {
    $isProduct = TRUE;
  }
  return $isProduct;
}

/**
 * Function for checking if PLP.
 */
function is_plp_page() {
  $isListingPage = FALSE;
  $term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if (is_object($term) && $term->bundle() == 'acq_product_category') {
    $isListingPage = TRUE;
  }
  return $isListingPage;
}
