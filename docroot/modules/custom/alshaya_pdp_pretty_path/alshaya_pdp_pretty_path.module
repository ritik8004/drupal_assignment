<?php

/**
 * @file
 * Module file.
 */

use Drupal\acq_commerce\SKUInterface;

 /**
 * Implements hook_alshaya_search_algolia_object_alter().
 */
function alshaya_pdp_pretty_path_alshaya_search_algolia_object_alter(array &$object) {
  /** @var \Drupal\alshaya_acm_product\SkuManager $skuManager */
  $skuManager = \Drupal::service('alshaya_acm_product.skumanager');
  $swatch_attribute = $skuManager->getPdpSwatchAttributes();

  if (!empty($swatch_attribute)) {
    /** @var \Drupal\alshaya_pdp_pretty_path\Service\AlshayaPdpPrettyPathHelper $pdpPrettyPathHelper */
    $pdpPrettyPathHelper = \Drupal::service('alshaya_pdp_pretty_path.helper');
    $pdpPrettyPathHelper->prepareAndIndexSwatchUrls($object, $swatch_attribute);
  }
}

/**
 * Implements hook_alshaya_feed_variant_info_alter().
 */
function alshaya_pdp_pretty_path_alshaya_feed_variant_info_alter(&$variant, SKUInterface $sku) {
  /** @var \Drupal\alshaya_acm_product\SkuManager $skuManager */
  $skuManager = \Drupal::service('alshaya_acm_product.skumanager');
  $swatch_attributes = $skuManager->getPdpSwatchAttributes();
  /** @var \Drupal\alshaya_pdp_pretty_path\Service\AlshayaPdpPrettyPathHelper $pdpPrettyPathHelper */
  $pdpPrettyPathHelper = \Drupal::service('alshaya_pdp_pretty_path.helper');

  foreach ($swatch_attributes as $attribute) {
    $value = $sku->get('attr_' . $attribute)->getString();
    if (!empty($value)) {
      $variant['url'] = $pdpPrettyPathHelper->preparePrettyPathUrl(strtok($variant['url'], '?'), $attribute, $value);
      // Use only first swatch attribute for pretty path.
      break;
    }
  }
}
