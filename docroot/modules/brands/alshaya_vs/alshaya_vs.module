<?php

/**
 * @file
 * The Module file.
 */

/**
 * Implements hook_form_alter().
 */
function alshaya_vs_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if (\Drupal::moduleHandler()->moduleExists('alshaya_email_signup') && $form_id == 'webform_submission_alshaya_email_signup_form') {
    $lang = \Drupal::languageManager()->getDefaultLanguage()->getId();
    $uuid = '19207aad-0e43-4d3a-96d7-c74141f75bb1';
    $entity_manager = \Drupal::getContainer()->get('entity.manager');
    $block = $entity_manager->loadEntityByUuid('block_content', $uuid);
    if (!empty($block)) {
      $build = $entity_manager->getViewBuilder('block_content')->view($block, 'full', $lang);

      // Add the title to text so it is searchable.
      $build['search_title'] = [
        '#prefix' => '<h2>',
        '#plain_text' => $block->label(),
        '#suffix' => '</h2>',
        '#weight' => -1000
      ];

      $form['info_block'] = [
        '#type' => 'item',
        '#markup' => \Drupal::getContainer()->get('renderer')->renderPlain($build),
        '#weight' => -100,
        '#prefix' => '<div class="form--content">',
        '#suffix' => '</div>'
      ];
    }
  }
}

/**
 * Implements hook_page_attachments().
 */
function alshaya_vs_page_attachments(array &$attachments) {
  foreach ($attachments['#attached'] as $type => $elements) {
    foreach ($attachments['#attached'][$type] as $key => $value) {
      // Search for back_to_top library and unset it.
      if ($type == 'library') {
        if (strpos($value, 'back_to_top') !== FALSE) {
          unset($attachments['#attached'][$type][$key]);
        }
      }

      // Search for back_to_top settings and unset it.
      if ($type == 'drupalSettings') {
        if (strpos($key, 'back_to_top') !== FALSE) {
          unset($attachments['#attached'][$type][$key]);
        }
      }
    }
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function alshaya_vs_module_implements_alter(&$implementations, $hook) {
  // Alter page_attachments implementation for alshaya_vs to call at last.
  if ($hook == 'page_attachments') {
    $group = $implementations['alshaya_vs'];
    unset($implementations['alshaya_vs']);
    $implementations['alshaya_vs'] = $group;
  }
}
