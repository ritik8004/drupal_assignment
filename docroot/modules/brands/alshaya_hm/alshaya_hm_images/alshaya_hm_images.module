<?php

/**
 * @file
 * Module file.
 */

use Drupal\acq_commerce\SKUInterface;
use Drupal\acq_sku\Entity\SKU;
use Drupal\acq_sku\Plugin\AcquiaCommerce\SKUType\Configurable;
use Drupal\alshaya_hm_images\SkuAssetManager;
use Drupal\Core\Block\BlockPluginInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\file\FileInterface;
use Drupal\image\Entity\ImageStyle;

/**
 * Implements hook_acq_sku_product_sku_alter().
 */
function alshaya_hm_images_acq_sku_product_sku_alter(SKU $sku, array $product, array $existing_data) {
  // Process assets data & create attributes which are needed for sorting
  // the assets while displaying them.
  $existing_assets = !empty($existing_data['attr_assets'])
    ? unserialize($existing_data['attr_assets'][0]['value'])
    : [];

  $sku->get('attr_assets')->setValue(_alshaya_hm_images_acq_sku_process_assets($product, $existing_assets));
}

/**
 * Helper function to process asset attributes & calculate sorting params.
 *
 * @param array $product
 *   Product array containing assets to be processed.
 * @param array $existing_assets
 *   Existing assets data.
 *
 * @return string
 *   Serialized & processed assets.
 */
function _alshaya_hm_images_acq_sku_process_assets(array $product, array $existing_assets) {
  $existing_assets_mapping = [];

  foreach ($existing_assets ?? [] as $key => $asset) {
    if (empty($asset['fid'])) {
      continue;
    }

    $id = $asset['pims_image']['id'] ?? $asset['Data']['AssetId'];
    $existing_assets_mapping[$id] = $asset;
  }

  $assets = [];
  if (isset($product['extension'], $product['extension']['assets'])) {
    $assets = $product['extension']['assets'];

    foreach ($assets as $key => $asset) {
      // If asset had no pims data before and has pims data now, asset id here
      // won't match and hence we will not use old downloaded image.
      $id = $asset['pims_image']['id'] ?? $asset['Data']['AssetId'];

      if (isset($existing_assets_mapping[$id])) {
        $assets[$key]['fid'] = $existing_assets_mapping[$id]['fid'];
        $assets[$key]['drupal_uri'] = $existing_assets_mapping[$id]['drupal_uri'];
        unset($existing_assets_mapping[$id]);
      }
      else {
        // Ensure fid and drupal_uri are not available in assets if we are
        // not re-using.
        unset($assets[$key]['fid']);
        unset($assets[$key]['drupal_uri']);
      }

      if (empty($asset['Data']['AssetType']) && ($asset['is_old_format'] && empty($asset['Type']))) {
        continue;
      }

      $asset_type_parts = (!empty($asset['Data']['AssetType'])) ? explode('/', $asset['Data']['AssetType']) : [];
      $assets[$key]['sortAssetType'] = !empty($asset['is_old_format']) ? $asset['Type'] : end($asset_type_parts);
      $face_type = SkuAssetManager::LP_DEFAULT_ANGLE;

      if (!empty($asset['Data']['Angle']['Facing']) && !empty($asset['Data']['Angle']['Identifier'])) {
        $face_type = $asset['Data']['Angle']['Facing'] . $asset['Data']['Angle']['Identifier'];
      }
      $assets[$key]['sortFacingType'] = $face_type;
    }
  }

  $fileStorage = \Drupal::entityTypeManager()->getStorage('file');
  foreach ($existing_assets_mapping ?? [] as $asset) {
    $file = $fileStorage->load($asset['fid']);

    if ($file instanceof FileInterface) {
      $file->delete();
    }
  }

  return serialize($assets);
}

/**
 * Implements hook_alshaya_acm_product_gallery_alter().
 */
function alshaya_hm_images_alshaya_acm_product_gallery_alter(array &$gallery, SKUInterface $sku, $context = 'pdp') {
  /** @var \Drupal\alshaya_hm_images\SkuAssetManager $sku_assets_manager */
  $sku_assets_manager = \Drupal::service('alshaya_hm_images.skuassetsmanager');

  // Check if the gallery has a main image. If not, look for assets.
  if ($context == 'search') {
    // Lookup images on current SKU if its a simple SKU.
    $main_image_assets = $sku_assets_manager->getSkuAssets($sku, 'plp');
    $avoid_assets = !empty($main_image_assets) && !empty($main_image_assets[0]['Data']) ? [$main_image_assets[0]['Data']['AssetId']] : [];
    $hover_image_assets = $sku_assets_manager->getSkuAssets($sku, 'plp_hover', $avoid_assets);

    // If no assets attached & the sku is configurable, try to use the
    // assets attached with first child sku.
    if (empty($main_image_assets) && empty($hover_image_assets) && ($sku->bundle() === 'configurable')) {
      $main_image_assets = $sku_assets_manager->getChildSkuAssets($sku, 'plp');
      $avoid_assets = !empty($main_image_assets) && !empty($main_image_assets[0]['Data']) ? [$main_image_assets[0]['Data']['AssetId']] : [];
      $hover_image_assets = $sku_assets_manager->getChildSkuAssets($sku, 'plp_hover', $avoid_assets);
    }

    $plp_main_image = !empty($main_image_assets) ? $main_image_assets[0] : NULL;
    $plp_hover_image = !empty($hover_image_assets) ? $hover_image_assets[0] : NULL;

    if ($plp_main_image) {
      $gallery = [
        '#theme' => 'alshaya_assets_gallery',
        '#mainImage' => $plp_main_image,
      ];

      // We don't get alt/title, we use product's title for that.
      $gallery['#label'] = $sku->label();

      if ($plp_hover_image) {
        $gallery['#hoverImage'] = $plp_hover_image;
      }
    }
  }
}

/**
 * Implements hook_alshaya_acm_product_media_items_alter().
 */
function alshaya_hm_images_alshaya_acm_product_media_items_alter(array &$media, SKU $sku) {
  /** @var \Drupal\alshaya_hm_images\SkuAssetManager $assetsManager */
  $assetsManager = \Drupal::service('alshaya_hm_images.skuassetsmanager');

  $assets = $assetsManager->getAssets($sku);

  foreach ($assets ?? [] as $asset) {
    if (!empty($asset['drupal_uri'])) {
      $asset['media_type'] = 'image';
      $media[] = $asset;
    }
  }
}

/**
 * Implements hook_alshaya_acm_product_build_alter().
 */
function alshaya_hm_images_alshaya_acm_product_build_alter(array &$build, SKUInterface $sku, $context = 'pdp') {
  /** @var \Drupal\alshaya_hm_images\SkuAssetManager $sku_assets_manager */
  $sku_assets_manager = \Drupal::service('alshaya_hm_images.skuassetsmanager');

  /** @var \Drupal\alshaya_acm_product\SkuManager $skuManager */
  $skuManager = \Drupal::service('alshaya_acm_product.skumanager');

  if ($context == 'search') {
    $swatches_display_status = \Drupal::config('alshaya_acm_product.display_settings')->get('color_swatches');

    // We do not display swatches for color nodes.
    $color = $build['#color'] ?? '';
    if ($swatches_display_status && empty($color)) {
      $swatches = array_filter($sku_assets_manager->getColorsForSku($sku));
      if ($swatches) {
        $swatch_plp_limit = \Drupal::config('alshaya_hm_images.settings')->get('swatch_plp_limit');
        $build['#swatches'] = array_slice($swatches, 0, $swatch_plp_limit, TRUE);
        $build['#swatch_more_text'] = count($swatches) > $swatch_plp_limit
          ? t('+ @swatch_count more', ['@swatch_count' => count($swatches) - $swatch_plp_limit])
          : FALSE;
      }
    }
  }
  elseif (in_array($context, ['teaser', 'product_category_carousel'])) {
    /** @var \Drupal\alshaya_acm_product\SkuImagesManager $skuImagesManager */
    $skuImagesManager = \Drupal::service('alshaya_acm_product.sku_images_manager');
    try {
      $sku_for_gallery = $skuImagesManager->getSkuForGallery($sku);
    }
    catch (\Exception $e) {
      return;
    }

    $teaser_assets = $sku_assets_manager->getSkuAssets($sku_for_gallery, 'teaser');

    // Try once with plp assets if nothing found for teaser.
    if (empty($teaser_assets)) {
      $teaser_assets = $sku_assets_manager->getSkuAssets($sku_for_gallery, 'plp');
    }

    if (!empty($teaser_assets)) {
      $sku_media = reset($teaser_assets);
      $build['image'] = $skuManager->getSkuImage($sku_media['drupal_uri'], $sku->label(), 'product_teaser');
    }
  }
  elseif ($context == 'pdp' && !empty($build['free_gift_promotions']['#free_sku_code']) && empty($build['free_gift_promotions']['#sku_image'])) {
    $free_sku_assets = $sku_assets_manager->getSkuAssets($build['free_gift_promotions']['#free_sku_code'], 'swatch');

    if (!empty($free_sku_assets)) {
      $build['free_gift_promotions']['#sku_image'] = [
        '#theme' => 'image',
        '#attributes' => [
          'src' => $free_sku_assets[0]['url']->toString(),
          'title' => $sku->label(),
          'alt' => $sku->label(),
        ],
      ];
    }
  }
}

/**
 * Implements hook_acq_sku_pdp_gallery_media_alter().
 */
function alshaya_hm_images_acq_sku_pdp_gallery_media_alter(&$main_image, &$thumb_images, $sku) {
  if (empty($main_image) && ($sku instanceof SKU)) {
    /** @var \Drupal\alshaya_hm_images\SkuAssetManager $sku_assets_manager */
    $sku_assets_manager = \Drupal::service('alshaya_hm_images.skuassetsmanager');

    if ($sku instanceof SKU) {
      $pdp_images = $sku_assets_manager->getImagesForSku($sku, 'pdp');

      foreach ($pdp_images['pdp_thumbnail'] ?? [] as $key => $thumbnail) {
        $thumb_images[$key]['zoomurl'] = $pdp_images['pdp_fullscreen'][$key]['url'];
        $thumb_images[$key]['thumburl'] = $thumbnail['url'];
        $thumb_images[$key]['mediumurl'] = $pdp_images['pdp_main'][$key]['url'];
        $thumb_images[$key]['type'] = 'image';
        $thumb_images[$key]['fullurl'] = $pdp_images['pdp_fullscreen'][$key]['url'];
        $thumb_images[$key]['label'] = $sku->label();
      }

      // Check on main images is sufficient here, since zoom images are
      // variations of main images.
      if (!empty($pdp_images['pdp_main'])) {
        $main_image['zoomurl'] = $pdp_images['pdp_fullscreen'][0]['url'];
        $main_image['mediumurl'] = $pdp_images['pdp_main'][0]['url'];
        $main_image['label'] = $sku->label();
      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function alshaya_hm_images_form_sku_base_form_alter(&$form, FormStateInterface $form_state) {
  $tree = [];
  if ($tree_sku = $form_state->get('tree_sku')) {
    $sku = SKU::loadFromSku($tree_sku);
    $tree = Configurable::deriveProductTree($sku);
  }

  // Check if the product is configurable.
  if (!empty($tree['parent'])) {
    $parent_sku = $tree['parent'];
    /** @var \Drupal\alshaya_hm_images\SkuAssetManager $sku_asset_manager */
    $sku_asset_manager = \Drupal::service('alshaya_hm_images.skuassetsmanager');
    $swatch_type = $sku_asset_manager->getSkuSwatchType($parent_sku);

    // If the form has color config attribute available.
    if (isset($form['ajax']['configurables']['article_castor_id'])) {
      $options = &$form['ajax']['configurables']['article_castor_id']['#options'];
      $form['ajax']['configurables']['article_castor_id']['#title'] = t('Color');
      $form['ajax']['configurables']['article_castor_id']['#attributes']['data-default-title'] = t('Color');

      // Translate color attribute option values to the rgb color values &
      // expose the same in Drupal settings to javascript.
      foreach ($options as $key => $option) {
        if (isset($tree['combinations']['attribute_sku']['article_castor_id'][$key])) {
          foreach ($tree['combinations']['attribute_sku']['article_castor_id'][$key] as $variant_sku_code) {
            $variant_sku = SKU::loadFromSku($variant_sku_code);

            if (!($variant_sku instanceof SKU)) {
              continue;
            }

            $assets = [];
            if (strtoupper($swatch_type) !== SkuAssetManager::LP_SWATCH_RGB) {
              $assets = $sku_asset_manager->getSkuAssets($variant_sku, 'swatch');
            }

            $options[$key] = $variant_sku->get('attr_color_label')->getString();

            // If swatch type is not miniature_image or assets were missing from
            // sku, use rgb color code instead.
            $sku_configurable_options_color[$key] = [
              'display_label' => $options[$key],
              'swatch_type' => empty($assets) ? SkuAssetManager::LP_SWATCH_RGB : $swatch_type,
            ];

            if (empty($assets)) {
              $sku_configurable_options_color[$key]['display_value'] = $variant_sku->get('attr_rgb_color')->getString();
            }
            else {
              $url = ImageStyle::load('pdp_gallery_thumbnail')->buildUrl($assets[0]['drupal_uri']);
              $sku_configurable_options_color[$key]['display_value'] = '<img src="' . file_url_transform_relative($url) . '">';
            }

            break;
          }
        }
      }

      if (!empty($sku_configurable_options_color)) {
        $form['ajax']['configurables']['article_castor_id']['#attached']['drupalSettings']['sku_configurable_options_color'] = $sku_configurable_options_color;
      }
    }
  }
}

/**
 * Implements hook_acq_sku_base_field_additions_alter().
 */
function alshaya_hm_images_acq_sku_base_field_additions_alter(array &$fields = []) {
  $alshaya_acm_product_fields = \Drupal::config('alshaya_hm_images.sku_base_fields')->get('fields');
  $fields = array_merge($fields, $alshaya_acm_product_fields);
}

/**
 * Implements hook_alshaya_master_post_drupal_install().
 */
function alshaya_hm_images_alshaya_master_post_drupal_install() {
  // Add fields to store the values from attributes as fields.
  /** @var \Drupal\acq_sku\SKUFieldsManager $sku_fields_manager */
  $sku_fields_manager = \Drupal::service('acq_sku.fields_manager');

  $sku_fields_manager->updateFieldMetaInfo('color_label', [
    'configurable' => 1,
    'label' => 'Color',
  ]);
}

/**
 * Implements hook_alshaya_acm_product_light_product_data_alter().
 */
function alshaya_hm_images_alshaya_acm_product_light_product_data_alter(SKU $sku, array &$data, $type) {
  // If not light product, no need to process further.
  if ($type != 'light') {
    return;
  }

  $data['swatches'] = [];

  $swatches_display_status = (bool) \Drupal::config('alshaya_acm_product.display_settings')->get('color_swatches');
  if (!empty($data['color']) || !$swatches_display_status) {
    return;
  }

  /** @var \Drupal\alshaya_hm_images\SkuAssetManager $sku_assets_manager */
  $sku_assets_manager = \Drupal::service('alshaya_hm_images.skuassetsmanager');
  // Get colors for the SKU.
  $colors = $sku_assets_manager->getColorsForSku($sku);

  foreach ($colors as $key => $color) {
    $data['swatches'][] = [
      'key' => $key,
      'color_code' => $color,
    ];
  }
}

/**
 * Implements hook_alshaya_reset_config_configs_to_reset_alter().
 */
function alshaya_hm_images_alshaya_reset_config_configs_to_reset_alter(array &$reset) {
  // We need pims_base_url to be set per Magento instance.
  // We add it to the list of configs to be reset so it is done with other
  // configs like Connector URL, Magento URL, etc.
  $reset[] = 'alshaya_hm_images.settings';
}

/**
 * Implements hook_alshaya_acm_switch_magento_configs_alter().
 */
function alshaya_hm_images_alshaya_acm_switch_magento_configs_alter(array &$configs) {
  // We need pims_base_url to be set per Magento instance.
  // We add below for configs to be switched so it is set for Magento instance.
  $configs['alshaya_hm_images.settings'] = 'pims_base_url';
}

/**
 * Implements hook_block_view_alter().
 */
function alshaya_hm_images_block_view_alter(array &$build, BlockPluginInterface $block) {
  if ($build['#configuration']['id'] == 'alshaya_algolia_react_autocomplete') {
    $build['#attached']['library'][] = 'alshaya_hm_images/hm_images';
  }
}
