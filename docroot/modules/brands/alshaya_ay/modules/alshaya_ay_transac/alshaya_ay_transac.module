<?php

/**
 * @file
 * Alshaya AY Transac module file.
 */

use Drupal\taxonomy\TermInterface;
use Drupal\Core\Cache\Cache;

/**
 * Implements hook_library_info_alter().
 */
function alshaya_ay_transac_library_info_alter(&$libraries, $extension) {
  // Attach mobile_menu library wherever the alshaya_algolia_react
  // library is loaded.
  if ($extension === 'alshaya_algolia_react' && isset($libraries['autocomplete'])) {
    $libraries['autocomplete']['dependencies'][] = 'alshaya_ay_transac/mobile_menu';
  }
}

/**
 * Implements hook_preprocess_block().
 */
function alshaya_ay_transac_preprocess_block(&$variables) {
  if ($variables['base_plugin_id'] == 'alshaya_rcs_shop_by_block') {
    $variables['#cache']['contexts'][] = 'super_category';
    $variables['#cache']['tags'] = !empty($variables['#cache']['tags'])
      ? $variables['#cache']['tags']
      : [];
    // Get current super category term from route.
    $term = \Drupal::service('alshaya_acm_product_category.product_category_tree')->getCategoryTermFromRoute();
    if ($term instanceof TermInterface) {
      /** @var \Drupal\Core\Entity\EntityRepositoryInterface $entity_repository */
      $entity_repository = \Drupal::service('entity.repository');
      $term_en = $entity_repository->getTranslationFromContext($term, 'en');
      // Default block label is Shop By.
      // Only update block label for footer menu block as per
      // current super category if not on `Shop` super category.
      if (strtolower($term_en->label()) !== 'shop') {
        $term = $entity_repository->getTranslationFromContext($term);
        $variables['label'] = $term->label();
        $variables['#cache']['tags'] = Cache::mergeTags($variables['#cache']['tags'] ?? [], $term->getCacheTags());
      }
    }
  }
}
