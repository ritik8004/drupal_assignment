<?php

/**
 * @file
 * Module file.
 */

use Drupal\Core\Cache\Cache;

/**
 * Implements hook_theme().
 */
function alshaya_sofa_sectional_theme() {
  return [
    'sofa_sectional_strings' => [
      'variables' => [
        'strings' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_sofa_sectional_page_attachments_alter(array &$page) {
  // @todo attach library only when the feature is enabled,
  // current page is a PDP page and one of the product category
  // matches the category_ids in config.
  // Attach the sofa_sectional library.
  $page['#attached']['library'][] = 'alshaya_sofa_sectional/sofa_sectional';

  // Pass config for showing/hiding quantity selector in configurable product form.
  $page['#attached']['drupalSettings']['sofa_sectional']['show_quantity'] = \Drupal::service('acq_sku.cart_form_helper')->showQuantity();
  $page['#cache']['tags'] = Cache::mergeTags($page['#cache']['tags'], ['config:acq_sku.configurable_form_settings']);

  // Send the cart quantity options to be used while displaying quantity
  // dropdown. Adding the setting to global namespace.
  $page['#attached']['drupalSettings']['sofa_sectional']['cart_quantity_options'] = _alshaya_acm_get_cart_quantity_options();
  $page['#cache']['tags'] = Cache::mergeTags($page['#cache']['tags'], ['config:alshaya_acm.cart_config']);

  // Pass max sale quantity status and whether message show be shown.
  $alshaya_acm_settings = \Drupal::config('alshaya_acm.settings');
  $page['#attached']['drupalSettings']['sofa_sectional']['max_sale_quantity_enabled'] = $alshaya_acm_settings->get('quantity_limit_enabled');
  $page['#attached']['drupalSettings']['sofa_sectional']['max_sale_hide_message'] = $alshaya_acm_settings->get('hide_max_qty_limit_message');
  $page['#cache']['tags'] = Cache::mergeTags($page['#cache']['tags'], $alshaya_acm_settings->getCacheTags());
}

/**
 * Implements hook_preprocess_page().
 */
function alshaya_sofa_sectional_preprocess_page(&$variables) {
  \Drupal::moduleHandler()->loadInclude('alshaya_sofa_sectional', 'inc', 'alshaya_sofa_sectional.static_strings');
  $sofa_sectional_strings = [
    '#strings' => _alshaya_sofa_sectional_strings(),
    '#theme' => 'sofa_sectional_strings',
  ];

  $status = \Drupal::requestStack()->getCurrentRequest()->attributes->get('exception');
  // For 404 page, page.content is not rendered so we add it to pre_content.
  if ($status && $status->getStatusCode() == 404){
    $variables['page']['pre_content']['sofa_sectional_strings'] = $sofa_sectional_strings;
  }
  else {
    $variables['page']['content']['sofa_sectional_strings'] = $sofa_sectional_strings;
  }
}
