<?php

/**
 * @file
 * Module file.
 */

use Drupal\acq_commerce\SKUInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\node\NodeInterface;
use Symfony\Component\Yaml\Yaml;

/**
 * Implements hook_alshaya_acm_product_build_alter().
 */
function alshaya_bazaar_voice_alshaya_acm_product_build_alter(&$build, SKUInterface $sku, $context = 'pdp') {
  if ($context !== 'pdp') {
    return;
  }

  /** @var \Drupal\alshaya_acm_product\SkuManager $skuManager */
  $skuManager = \Drupal::service('alshaya_acm_product.skumanager');
  $productNode = $skuManager->getDisplayNode($sku->getSku());

  if ($productNode instanceof NodeInterface) {
    $config = \Drupal::config('bazaar_voice.settings');
    // Disable BazaarVoice Rating and Review in PDP
    // if checkbox is checked in bazaarVoice Settings Form.
    if ($config->get('pdp_rating_reviews')) {
      return;
    }
    // Disable BazaarVoice Rating and Review in PDP
    // if checkbox is checked for any categories or its Parent Categories.
    $showRatingReviews = TRUE;
    $hide_fields_write_review = [];
    $category = $productNode->get('field_category')->getValue();
    foreach ($category as $term) {
      $term_parents = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadAllParents($term['target_id']);
      foreach ($term_parents as $term_obj) {
        // Enable R&R feature based on category.
        if (!empty($term_obj->get('field_rating_review')->getValue()[0]['value'])) {
          $showRatingReviews = FALSE;
        }
        // Get fields from category not be displayed in write a review form.
        if (!empty($term_obj->get('field_write_review_form_fields')->getValue())) {
          $field_ids = [];
          foreach ($term_obj->get('field_write_review_form_fields')->getValue() as $value) {
            $field_ids[] = $value['value'];
          }
          $hide_fields_write_review = $field_ids;
        }
      }
    }
    if (!$showRatingReviews) {
      return;
    }
    /** @var \Drupal\alshaya_acm_product\SkuImagesManager $skuImagesManager */
    $skuImagesManager = \Drupal::service('alshaya_acm_product.sku_images_manager');
    $media = $skuImagesManager->getFirstImage($sku, 'pdp');
    $image_url = '';
    if (!empty($media)) {
      $image_url = file_create_url($media['drupal_uri']);
    }

    $alshayaBazaarVoice = \Drupal::service('alshaya_bazaar_voice.service');
    // Get avalable sorting options from config.
    $sorting_options = $alshayaBazaarVoice->getSortingOptions();
    // Get the filter options to be rendered on review summary.
    $filter_options = \Drupal::config('bazaar_voice_filter_review.settings')->get('pdp_filter_options');
    $filter_options = Yaml::parse($filter_options);

    // Get country code.
    $country_code = _alshaya_custom_get_site_level_country_code();
    // Get sanitized sku.
    $sanitized_sku = $skuManager->getSanitizedSku($sku->getSku());

    // Check if logged in user has already reviewed the product.
    $is_reviewed = $alshayaBazaarVoice->isReviewedByCurrentUser($sanitized_sku);

    $settings = [
      'user' => [
        'user_email' => \Drupal::currentUser()->getEmail(),
        'user_id' => \Drupal::currentUser()->id(),
        'user_name' => \Drupal::currentUser()->getUsername(),
        'is_reviewed' => $is_reviewed,
      ],
      'product' => [
        'url' => $productNode->toUrl()->toString(),
        'title' => $productNode->label(),
        'image_url' => $image_url,
      ],
      'bazaar_voice' => [
        'endpoint' => $config->get('api_base_url'),
        'api_version' => $config->get('api_version'),
        'passkey' => $config->get('conversations_apikey'),
        'locale' => $config->get('locale'),
        'content_locale' => $config->get('content_locale'),
        'max_age' => $config->get('max_age'),
        'stats' => 'Reviews',
        'Include' => $config->get('bv_content_types'),
        'sorting_options' => $sorting_options,
        'filter_options' => $filter_options,
        'reviews_pagination_type' => $config->get('reviews_pagination_type'),
        'reviews_initial_load' => $config->get('reviews_initial_load'),
        'reviews_on_loadmore' => $config->get('reviews_on_loadmore'),
        'reviews_per_page' => $config->get('reviews_per_page'),
        'write_review_submission' => $config->get('write_review_submission'),
        'write_review_tnc' => $config->get('write_review_tnc'),
        'write_review_guidlines' => $config->get('write_review_guidlines'),
        'comment_form_tnc' => $config->get('comment_form_tnc'),
        'comment_box_min_length' => $config->get('comment_box_min_length'),
        'comment_box_max_length' => $config->get('comment_box_max_length'),
        'country_code' => $country_code,
      ],
      'base_url' => \Drupal::request()->getSchemeAndHttpHost(),
      'bv_auth_token' => \Drupal::request()->get('bv_authtoken'),
      'hide_fields_write_review' => $hide_fields_write_review,
    ];

    // Get the current pdp layout.
    $config = \Drupal::config('alshaya_acm_product.settings');
    $product_pdp_layout = $config->get('pdp_layout');

    if (!empty($productNode->get('field_select_pdp_layout')->getValue()[0]['value'])) {
      $product_pdp_layout = $productNode->get('field_select_pdp_layout')->getValue()[0]['value'];
    }

    $build['reviews_rating']['#markup'] = '<div id="reviews-rating"></div>';
    $build['reviews_section']['#markup'] = '<div id="reviews-section"></div>';

    if ($product_pdp_layout !== 'magazine_v2') {
      $build['#attached']['library'][] = 'alshaya_bazaar_voice/rating';
      $build['#attached']['library'][] = 'alshaya_bazaar_voice/reviews';
    }

    $build['#attached']['library'][] = 'alshaya_bazaar_voice/iovation';
    $build['#cache']['contexts'][] = 'url.query_args:bv_authtoken';
    $build['#attached']['drupalSettings']['productInfo'][$sanitized_sku]['alshaya_bazaar_voice'] = $settings;
  }
}

/**
 * Implements hook_theme().
 */
function alshaya_bazaar_voice_theme($existing, $type, $theme, $path) {
  return [
    'alshaya_bazaar_voice_reviews' => [
      'variables' => [
        'strings' => [],
      ],
      'template' => 'alshaya-bazaar-voice-reviews',
    ],
  ];
}

/**
 * Implements hook_page_attachments().
 */
function alshaya_bazaar_voice_page_attachments(array &$page) {
  // Configurations must be on page before iovation's JavaScript loads.
  // Add script to generate the device finger printing string.
  $page['#attached']['html_head'][] = [[
    '#type' => 'html_tag',
    '#tag' => 'script',
    '#attributes' => [
      'type' => 'text/javascript',
      ],
    '#value' => 'window.IGLOO = window.IGLOO || {
    "bbout_element_id" : "ioBlackBox","enable_rip" : true,"enable_flash" : false,"install_flash" : false,"loader" : {"version" : "general5","fp_static" : false}};',
    ],
    'fppath',
    ];
}

/**
 * Implements hook_alshaya_spc_checkout_confirmation_order_build_alter().
 * Updating build array for bv pixel integration.
 *
 * @param array $build
 *   Reference to the build array of spc confirmation.
 * @param string $order
 *   Order details array.
 */
function alshaya_bazaar_voice_alshaya_spc_checkout_confirmation_order_build_alter(array &$build, $order) {
  /** @var \Drupal\bazaar_voice\BazaarVoiceApiHelper $bazaar_voice */
  $bazaar_voice_api_helper = \Drupal::service('bazaar_voice.api_helper');
  if (!empty($build['#attached']['drupalSettings'])){
    if ($bazaar_voice_api_helper->isBvConfigurationsAvailable()) {
      $bazaarvoice_config = \Drupal::config('bazaar_voice.settings');
      $locale = $bazaarvoice_config->get('locale');
      // Attach bvpixel library to order confirmation page.
      $build['#attached']['library'][] = 'alshaya_bazaar_voice/bvpixel_tracking';
      if(!empty($build['#attached']['drupalSettings']['order_details'])) {
        $build['#attached']['drupalSettings']['order_details']['bv_extra_params'] = [
          'currency' => $order['base_currency_code'] ?? '',
          'tax' => $order['base_tax_amount'] ?? '',
          'shipping' => $order['shipping_incl_tax'] ?? '',
          'city' => $order['shipping']['address']['city'] ?? '',
          'country' => $order['shipping']['address']['country_id'] ?? '',
          'nickname' => $order['customer_firstname'] ?? '',
          'customer_is_guest' => $order['customer_is_guest'] ?? '',
          'customer_id' => $order['customer_id'] ?? '',
          'locale' => $locale ?? '',
        ];
      }
    }
  }
}

/**
 * Implements allowed values callback.
 */
function alshaya_bazaar_voice_write_review_fields() {
  $write_review_fields = [];
  /** @var \Drupal\alshaya_bazaar_voice\AlshayaBazaarVoice $alshaya_bazaar_voice */
  $alshaya_bazaar_voice = \Drupal::service('alshaya_bazaar_voice.service');
  // Get optional fields and set based on categories.
  $fields_config = $alshaya_bazaar_voice->getWriteReviewFieldsConfig();
  foreach ($fields_config as $key => $value) {
    if ($value['#visible'] && $value['#type'] !== 'processed_text' && !$value['#required']) {
      $write_review_fields[$value['#id']] = $value['#title'];
    }
  }

  return $write_review_fields;
}

/**
 * Implements hook_alshaya_my_account_links_alter().
 */
function alshaya_bazaar_voice_alshaya_my_account_links_alter(array &$links) {
  // Add reviews links for my account page.
  $links['user_reviews'] = [
    'text' => t('Reviews'),
    'route' => 'alshaya_bazaar_voice.user_reviews',
    'weight' => 41,
  ];
}

/**
 * Implements hook_alshaya_srp_sort_settings_form_alter().
 */
function alshaya_bazaar_voice_form_alshaya_srp_sort_settings_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['sort_options']['#options']['attr_bv_average_overall_rating'] = t('Top Rated');
}

/**
 * Implements hook_preprocess_node().
 */
function alshaya_bazaar_voice_preprocess_node(&$variables) {
  // Add bazaavoice related strings.
  if ($variables['node']->bundle() === 'acq_product') {
    \Drupal::moduleHandler()->loadInclude('alshaya_bazaar_voice', 'inc', 'alshaya_bazaar_voice.static_strings');
    $variables['bazaar_voice_strings'] = [
      '#theme' => 'alshaya_bazaar_voice_reviews',
      '#strings' => _alshaya_bazaar_voice_static_strings(),
    ];
  }
}
