<?php

/**
 * @file
 * Module file.
 */

use Drupal\acq_sku\Entity\SKU;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function alshaya_bazaar_voice_node_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  if ($entity->bundle() == 'acq_product') {
    /** @var \Drupal\alshaya_acm_product\SkuManager $skuManager */
    $skuManager = \Drupal::service('alshaya_acm_product.skumanager');

    $sku = $skuManager->getSkuForNode($entity);
    $sku_entity = SKU::loadFromSku($sku);

    if ($sku_entity instanceof SKU && $view_mode == 'full') {
      $config = \Drupal::config('bazaar_voice.settings');
      \Drupal::moduleHandler()->loadInclude('alshaya_bazaar_voice', 'inc', 'alshaya_bazaar_voice.static_strings');
      $settings = [
        'user' => [
          'user_email' => \Drupal::currentUser()->getEmail(),
        ],
        'bazaar_voice' => [
          'base_url' => \Drupal::request()->getSchemeAndHttpHost(),
          'endpoint' => $config->get('api_base_url'),
          'api_version' => $config->get('api_version'),
          'passkey' => $config->get('conversations_apikey'),
          'locale' => $config->get('locale'),
          'productid' => $sku_entity->getSku(),
          'stats' => 'Reviews',
          'Include' => 'Products'
        ]
      ];
      // Adding template to render string values.
      $build['bazaar_voice_strings']['#theme'] = 'alshaya_bazaar_voice_reviews';
      $build['bazaar_voice_strings']['#strings'] = _alshaya_bazaar_voice_static_strings();
      $build['reviews_rating']['#markup'] = '<div id="reviews-rating"></div>';
      $build['reviews_section']['#markup'] = '<div id="reviews-section"></div>';
      $build['#attached']['library'] = ['alshaya_bazaar_voice/rating', 'alshaya_bazaar_voice/reviews'];
      $build['#attached']['drupalSettings'] = $settings;

    }
  }
}

/**
 * Implements hook_theme().
 */
function alshaya_bazaar_voice_theme($existing, $type, $theme, $path) {
  return [
    'alshaya_bazaar_voice_reviews' => [
      'variables' => [
        'strings' => [],
      ],
      'template' => 'alshaya-bazaar-voice-reviews',
    ],
  ];
}
