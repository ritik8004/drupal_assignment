<?php

/**
 * @file
 * Contains alshaya_online_returns.module.
 */

use Drupal\acq_commerce\SKUInterface;
use Drupal\Core\Cache\Cache;

/**
 * Implements hook_preprocess_node().
 */
function alshaya_online_returns_preprocess_node(&$variables) {
  if (in_array($variables['node']->bundle(), ['acq_product', 'rcs_product'])) {
    $variables['online_returns_status'] = \Drupal::service('alshaya_online_returns.online_returns_helper')->isOnlineReturnsEnabled();
  }
}

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_online_returns_page_attachments_alter(array &$page) {
  /** @var \Drupal\alshaya_online_returns\Helper\OnlineReturnsHelper $onlineReturnsHelper */
  $onlineReturnsHelper = \Drupal::service('alshaya_online_returns.online_returns_helper');

  // Do not proceed if Online returns is not enabled.
  if (!$onlineReturnsHelper->isOnlineReturnsEnabled()) {
    return;
  }

  $current_route = \Drupal::routeMatch();
  $current_route_name = $current_route->getRouteName();

  if ($current_route_name === 'entity.node.canonical'
    && in_array($current_route->getParameter('node')->bundle(), [
      'rcs_product',
      'acq_product',
    ])
  ) {
    $page['#attached']['library'][] = 'alshaya_online_returns/alshaya_online_returns_pdp';
    // Attach the online return pdp gtm library.
    $page['#attached']['library'][] = 'alshaya_online_returns/alshaya_online_returns_pdp_gtm';

    // Attach the theming library.
    $page['#attached']['library'][] = 'alshaya_white_label/online-returns';
  }
  elseif ($current_route_name === 'entity.user.canonical') {
    $page['#attached']['library'][] = 'alshaya_online_returns/alshaya_online_returns_my_accounts';

    // Attach the theming library.
    $page['#attached']['library'][] = 'alshaya_white_label/online-returns';
  }

  // Add egift card refund settings in drupalSettings.
  $page['#attached']['drupalSettings']['egiftCardRefund']['enabled'] = $onlineReturnsHelper->isEgiftRefundEnabled();
  // Add the not supported payment methods for eGift refund in drupalSettings.
  $page['#attached']['drupalSettings']['egiftCardRefund']['notSupportedEgiftRefundPaymentMethods'] =
    $onlineReturnsHelper->getNotSupportedEgiftMethodsForOnlineReturns()
      ? array_keys(array_filter($onlineReturnsHelper->getNotSupportedEgiftMethodsForOnlineReturns(), fn($method) => $method !== '0'))
      : [];
  // Add egift card refund text in drupalSettings.
  $page['#attached']['drupalSettings']['egiftCardRefund']['egiftCardRefundText'] = $onlineReturnsHelper->getEgiftRefundText();
  // Add egift card icon in drupalSettings.
  $page['#attached']['drupalSettings']['egiftCardRefund']['egiftCardIcon'] = $onlineReturnsHelper->getEgiftCardIcon();
}

/**
 * Implements hook_sku_variant_info_alter().
 */
function alshaya_online_returns_sku_variant_info_alter(array &$variant, SKUInterface $child, ?SKUInterface $parent) {
  /** @var \Drupal\alshaya_online_returns\Helper\OnlineReturnsHelper $onlineReturnsHelper */
  $onlineReturnsHelper = \Drupal::service('alshaya_online_returns.online_returns_helper');

  // Do not process further if feature is disabled.
  if (!$onlineReturnsHelper->isOnlineReturnsEnabled()) {
    return;
  }

  $variant['eligibleForReturn'] = $onlineReturnsHelper->isSkuReturnable($child);
}

/**
 * Implements hook_alshaya_acm_product_build_alter().
 */
function alshaya_online_returns_alshaya_acm_product_build_alter(&$build, SKUInterface $sku, $context = 'pdp') {
  /** @var \Drupal\alshaya_online_returns\Helper\OnlineReturnsHelper $onlineReturnsHelper */
  $onlineReturnsHelper = \Drupal::service('alshaya_online_returns.online_returns_helper');

  $build['#cache']['tags'] = Cache::mergeTags(
    $build['#cache']['tags'] ?? [],
    $onlineReturnsHelper->getCacheTags(),
  );

  // Do not process further if feature is disabled.
  if (!$onlineReturnsHelper->isOnlineReturnsEnabled()) {
    return;
  }

  $build['#attached']['drupalSettings']['onlineReturns']['enabled'] = TRUE;

  if (isset($build['#attached']['drupalSettings']['productInfo'][$sku->getSku()])) {
    $build['#attached']['drupalSettings']['productInfo'][$sku->getSku()]['eligibleForReturn'] = $onlineReturnsHelper->isSkuReturnable($sku);
  }
}

/**
 * Implements hook_alshaya_acm_customer_recent_order_build_alter().
 */
function alshaya_online_returns_alshaya_acm_customer_recent_order_build_alter(array &$build) {
  /** @var \Drupal\alshaya_online_returns\Helper\OnlineReturnsHelper $onlineReturnsHelper */
  $onlineReturnsHelper = \Drupal::service('alshaya_online_returns.online_returns_helper');

  $build['#cache']['tags'] = Cache::mergeTags(
    $build['#cache']['tags'] ?? [],
    $onlineReturnsHelper->getCacheTags(),
  );

  // Do not process further if feature is disabled.
  if (!$onlineReturnsHelper->isOnlineReturnsEnabled()) {
    return;
  }

  foreach ($build['recent_order'] as $key => $order) {
    $build['recent_order'][$key]['#order']['online_returns_status'] = TRUE;
    $isBigTicketOrder = FALSE;
    // Loop over all the ordered items for each order.
    if (isset($build['recent_order'][$key]['#order']['items'])
      && is_array($build['recent_order'][$key]['#order']['items'])) {
      // Items count used to calculate count of fully refunded items.
      $items_count = count($build['recent_order'][$key]['#order']['items']);
      foreach ($build['recent_order'][$key]['#order']['items'] as $product_id => $product) {
        // If the number of refunded items is equal to the number of
        // ordered items decrease the items count by one.
        if ($product['refunded'] == $product['ordered']) {
          $items_count--;
        }

        // Check if the product is big ticket or not.
        // Proceed only if we haven't find any big ticket item to avoid
        // unnecessary iterations.
        if (!$isBigTicketOrder) {
          $isBigTicketOrder = $onlineReturnsHelper->isBigTicketItem($product);
        }
      }
      // Set online returns status based on the count of all products available
      // for return.
      $build['recent_order'][$key]['#order']['online_returns_status'] = $items_count > 0;
    }

    $build['#attached']['drupalSettings']['onlineReturns']['recentOrders'][$order['#order']['id']] = $onlineReturnsHelper->prepareOrderData($order['#order']);
    $build['#attached']['drupalSettings']['onlineReturns']['recentOrders'][$order['#order']['id']]['isBigTicketOrder'] = $isBigTicketOrder;
  }
  // Add customer service number for online returns.
  $build['#attached']['drupalSettings']['onlineReturns']['customerServiceNumber'] = \Drupal::config('alshaya_online_returns.return_confirmation')->get('customer_service_number') ?? '';
}

/**
 * Implements hook_alshaya_acm_customer_orders_details_build_alter().
 */
function alshaya_online_returns_alshaya_acm_customer_orders_details_build_alter(array &$order, array &$build) {
  /** @var \Drupal\alshaya_online_returns\Helper\OnlineReturnsHelper $onlineReturnsHelper */
  $onlineReturnsHelper = \Drupal::service('alshaya_online_returns.online_returns_helper');

  $build['#cache']['tags'] = Cache::mergeTags(
    $build['#cache']['tags'] ?? [],
    $onlineReturnsHelper->getCacheTags()
  );

  // Do not process further if feature is disabled.
  if (!$onlineReturnsHelper->isOnlineReturnsEnabled()) {
    return;
  }

  $build['#order']['online_returns_status'] = TRUE;

  // Remove the full product item if the refunded item is equal to ordered
  // items.
  foreach ($build['#products'] as $key => &$value) {
    // Store the product info in a new variable so that we can use it to build
    // the refunded block.
    $build['#refunded_products'][$key] = $value;

    if ($value['refunded'] === $value['ordered']) {
      unset($build['#products'][$key]);
      continue;
    }

    if ($value['refunded'] > 0 && $value['refunded'] <= $value['ordered']) {
      $value['ordered'] -= $value['refunded'];
    }

    // Get the new total based the the available quantity.
    $value['total'] = alshaya_acm_price_format($value['ordered'] * $value['price_incl_tax']);
  }
  // Rebuilding the array as after unsetting key, array
  // gets converted to object in react if first index missing.
  $build['#products'] = array_values($build['#products']);

  $build['#attached']['drupalSettings']['onlineReturns'] = $onlineReturnsHelper->prepareOrderData($order);
  $build['#attached']['drupalSettings']['onlineReturns']['gtm_info'] = \Drupal::service('alshaya_seo_transac.gtm_manager')->fetchCompletedOrderAttributes($order);
  $build['#attached']['drupalSettings']['onlineReturns']['return_config'] = \Drupal::service('alshaya_online_returns.online_returns_api_helper')->getLanguageBasedReturnsConfig(
    \Drupal::languageManager()->getCurrentLanguage()->getId(),
  );

  // Add customer service number for online returns.
  $build['#attached']['drupalSettings']['onlineReturns']['customerServiceNumber'] = \Drupal::config('alshaya_online_returns.return_confirmation')->get('customer_service_number') ?? '';

  $refunded_products = $onlineReturnsHelper->prepareProductsData($build["#refunded_products"]);
  $build['#attached']['drupalSettings']['onlineReturns']['refunded_products'] = $refunded_products;

  // Add 'isBigTicketOrder' variable, TRUE if order contains atleast one
  // big ticket item otherwise don't add this variable.
  foreach ($refunded_products ?? [] as $product) {
    if (isset($product['is_big_ticket']) && $product['is_big_ticket']) {
      $build['#attached']['drupalSettings']['onlineReturns']['isBigTicketOrder'] = TRUE;
      break;
    }
  }

  // Attach the theming library.
  $build['#attached']['library'][] = 'alshaya_white_label/online-returns';
  // Attach the GTM library for online returns.
  $build['#attached']['library'][] = 'alshaya_seo_transac/gtm_online_returns';
}

/**
 * Implements hook_acq_sku_base_field_additions_alter().
 */
function alshaya_online_returns_acq_sku_base_field_additions_alter(array &$fields = []) {
  $alshaya_online_returns_fields = \Drupal::config('alshaya_online_returns.sku_base_fields')->get('fields');
  if ($alshaya_online_returns_fields) {
    $fields = array_merge($fields, $alshaya_online_returns_fields);
  }
  else {
    \Drupal::logger('alshaya_online_returns')->error('The config alshaya_online_returns.sku_base_fields is empty for online returns.');
  }
}

/**
 * Implements hook_alshaya_spc_checkout_build_alter().
 */
function alshaya_online_returns_alshaya_spc_cart_build_alter(array &$build) {
  /** @var \Drupal\alshaya_online_returns\Helper\OnlineReturnsHelper $onlineReturnsHelper */
  $onlineReturnsHelper = \Drupal::service('alshaya_online_returns.online_returns_helper');

  // Add the online return cart banner flag.
  $build['#attached']['drupalSettings']['onlineReturns']['cartBanner'] = $onlineReturnsHelper->isOnlineReturnsCartBannerEnabled();
  // Attach the theming library.
  $build['#attached']['library'][] = 'alshaya_white_label/online-returns';
}

/**
 * Implements hook_library_info_alter().
 */
function alshaya_online_returns_library_info_alter(&$libraries, $extension) {
  if ($extension === 'alshaya_spc' && isset($libraries['order_details'])) {
    $libraries['order_details']['dependencies'][] = 'alshaya_online_returns/alshaya_online_returns_util';
  }
}
