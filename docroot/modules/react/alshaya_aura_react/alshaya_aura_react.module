<?php

/**
 * @file
 * Contains alshaya_aura_react.module.
 */

use Drupal\alshaya_user\Plugin\Block\MyAccountLinks;
use Drupal\block\Entity\Block;
use Drupal\alshaya_aura_react\Helper\AuraStatus;
use Drupal\alshaya_aura_react\Helper\AuraTier;

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_aura_react_page_attachments_alter(array &$page) {
  $settings['enabled'] = 1;
  $uid = \Drupal::currentUser()->id();
  $user = \Drupal::entityTypeManager()->getStorage('user')->load($uid);
  $aura_helper = \Drupal::service('alshaya_aura_react.aura_helper');
  // Get country code.
  $country_code = _alshaya_custom_get_site_level_country_code();

  if (!empty($user)) {
    $settings['user_details'] = [
      'id' => $uid,
      'email' => \Drupal::currentUser()->getEmail(),
      'loyaltyStatus' => $aura_helper->getUserAuraStatus(),
      'tier' => $aura_helper->getUserAuraTier(),
    ];
  }

  $settings['allAuraTier'] = AuraTier::ALL_AURA_TIERS;
  $settings['allAuraStatus'] = AuraStatus::ALL_AURA_STATUS;

  $page['#attached']['library'][] = 'alshaya_aura_react/aura_header_library';
  $page['#attached']['library'][] = 'alshaya_white_label/aura-loyalty-global';

  $current_route = \Drupal::routeMatch()->getRouteName();
  // Attach aura library on cart/checkout page.
  if (in_array($current_route, ['acq_cart.cart', 'alshaya_spc.checkout'])) {
    $page['#attached']['library'][] = 'alshaya_white_label/aura-loyalty-spc';
  }
  elseif ($current_route === 'alshaya_spc.checkout.confirmation') {
    $page['#attached']['library'][] = 'alshaya_white_label/aura-loyalty-spc-confirmation';
  }
  elseif ($current_route === 'entity.user.canonical') {
    $page['#attached']['library'][] = 'alshaya_aura_react/alshaya_aura_my_accounts';

    $alshaya_aura_config = \Drupal::config('alshaya_aura_react.settings');
    $alshaya_master_config = \Drupal::config('alshaya_master.mobile_number_settings');

    $settings['config'] = [
      'appStoreLink' => $alshaya_aura_config->get('aura_app_store_link'),
      'googlePlayLink' => $alshaya_aura_config->get('aura_google_play_link'),
      'country_mobile_code' => \Drupal::service('mobile_number.util')->getCountryCode($country_code),
      'mobile_maxlength' => $alshaya_master_config->get('maxlength'),
    ];
  }

  $page['#attached']['drupalSettings']['aura'] = $settings;
}

/**
 * Implements hook_alshaya_my_account_links_alter().
 */
function alshaya_aura_react_alshaya_my_account_links_alter(array &$links) {
  // Add My Aura link.
  $links['alshaya_loyalty_club'] = [
    'text' => t('My Aura'),
    'route' => 'alshaya_aura_react.my_loyalty_club',
    'weight' => 11,
  ];
}

/**
 * Implements hook_theme().
 */
function alshaya_aura_react_theme() {
  $theme = [
    'aura_rewards_header' => [
      'variables' => [
        'learn_more_link' => '',
      ],
      'template' => 'aura-rewards-header',
    ],
    'aura_rewards_header_authenticated' => [
      'variables' => [
        'aura_user' => [],
      ],
      'template' => 'aura-rewards-header-authenticated',
    ],
    'aura_rewards_header_popup' => [
      'variables' => [],
      'template' => 'aura-rewards-header-popup',
    ],
    'aura_rewards_menu_item' => [
      'variables' => [
        'aura_user' => [],
      ],
      'template' => 'aura-rewards-menu-item',
    ],
  ];

  return $theme;
}

/**
 * Implements hook_preprocess_alshaya_main_menu_level1() for menu template.
 */
function alshaya_aura_react_preprocess_alshaya_main_menu_level1(array &$variables) {
  $block = Block::load('aurarewardsheader');
  $block_content = \Drupal::entityTypeManager()
    ->getViewBuilder('block')
    ->view($block);
  $variables['aura_rewards_header'] = $block_content;
  $variables['aura_enabled'] = 1;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function alshaya_aura_react_preprocess_html(&$variables) {
  if ($variables['logged_in']) {
    $my_account_links_routes = array_column(MyAccountLinks::getMyAccountLinks(), 'route');
    if (in_array(\Drupal::routeMatch()->getRouteName(), $my_account_links_routes)) {
      // Add class to body to distinguish between my account and other pages.
      $variables['attributes']['class'][] = 'aura-my-account';
    }
  }
}

/**
 * Implements hook_block_view_BASE_BLOCK_ID_alter().
 */
function alshaya_aura_react_block_view_alshaya_my_account_links_alter(&$build, $block) {
  // We remove the "Welcome @username" text from the mobile menu.
  if ($block->getPluginId() === 'alshaya_my_account_links') {
    $build['#pre_render'][] = '_alshaya_aura_react_my_account_block_pre_render';
  }
}

/**
 * Pre render callback for building My Account Links block.
 *
 * @param array $build
 *   The block build array.
 *
 * @return array
 *   The altered block build array.
 */
function _alshaya_aura_react_my_account_block_pre_render(array $build) {
  unset($build['content']['my_account_title']);

  $build['content']['my_account_my_aura_block_root'] = [
    '#markup' => '<div id="my-accounts-aura-mobile"></div>',
  ];

  $build['#attributes']['class'][] = 'aura-enabled';

  return $build;
}
