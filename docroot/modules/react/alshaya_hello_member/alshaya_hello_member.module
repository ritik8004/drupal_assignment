<?php

/**
 * @file
 * Module file.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\block\Entity\Block;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Access\AccessResult;

/**
 * Implements hook_module_implements_alter().
 */
function alshaya_hello_member_module_implements_alter(&$implementations, $hook) {
  // Call hook_alshaya_api_update_customer_api_request_alter at last.
  if ($hook == 'alshaya_api_update_customer_api_request_alter') {
    $group = $implementations['alshaya_hello_member'];
    unset($implementations['alshaya_hello_member']);
    $implementations['alshaya_hello_member'] = $group;
  }
}

/**
 * Implements hook_page_attachments_alter().
 */
function alshaya_hello_member_page_attachments_alter(array &$page) {
  /** @var \Drupal\alshaya_hello_member\Helper\HelloMemberHelper */
  $hello_member_helper = \Drupal::service('alshaya_hello_member.hello_member_helper');
  $settings['enabled'] = $hello_member_helper->isHelloMemberEnabled();
  $page['#cache']['tags'] = array_merge($page['#cache']['tags'] ?? [], \Drupal::config('alshaya_hello_member.settings')->getCacheTags());

  // Do not proceed if hello member is not enabled.
  if ($settings['enabled'] !== TRUE) {
    return;
  }

  $page['#attached']['drupalSettings']['hello_member'] = $settings;
}

/**
 * Implements hook_theme().
 */
function alshaya_hello_member_theme() {
  $theme = [
    'my_accounts_hello_member_block' => [
      'variables' => [
        'strings' => [],
      ],
    ],
    'my_membership_info_block' => [
      'variables' => [
        'strings' => [],
      ],
    ],
    'my_accounts_points_history' => [
      'variables' => [
        'strings' => [],
      ],
    ],
    'hello_member_benefits_page' => [
      'variables' => [
        'strings' => [],
      ],
    ],
  ];

  return $theme;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function alshaya_hello_member_form_user_register_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  /** @var \Drupal\alshaya_hello_member\Helper\HelloMemberHelper */
  $hello_member_helper = \Drupal::service('alshaya_hello_member.hello_member_helper');
  // Only add if hello member enabled.
  if (!$hello_member_helper->isHelloMemberEnabled()) {
    // For user registration form if we have the field, we remove it.
    if (isset($form['field_date_of_birth'])) {
      $form['field_date_of_birth']['#access'] = FALSE;
    }
    if (isset($form['field_gender'])) {
      $form['field_gender']['#access'] = FALSE;
    }
    return;
  }
  if (\Drupal::currentUser()->isAnonymous()) {
    $form['#title'] = t('Become a Member', [], ['context' => 'hello_member']);
    $form['hello_member_sub_title'] = [
      '#weight' => -12,
      '#markup' => '<div class="section-title">' . t('Become a member — don’t miss out on deals, offers, discounts and bonus vouchers.', [], ['context' => 'hello_member']) . '</div>',
    ];
    $form['hello_member'] = [
      '#type' => 'details',
      '#title' => '<div class="hello-member-add-more">' . t('Add More & Get More', [], ['context' => 'hello_member']) . '</div>',
      '#open' => FALSE,
      '#weight' => 8,
    ];
    $form['hello_member']['teasing'] = [
      '#type' => 'markup',
      '#markup' => t('Did you know that if you add some more information below you will earn more points and get a more personalised experience? How great is that?', [], ['context' => 'hello_member']),
      '#prefix' => '<div class="hello-member-accordion-wrapper">',
      '#weight' => 9,
    ];
    $form['hello_member']['field_date_of_birth'] = $form['field_date_of_birth'];
    $form['hello_member']['field_date_of_birth']['#suffix'] = '<div class="hello-member-gift-info">' . t('H&M wants to give you special treat on your birthday', [], ['context' => 'hello_member']) . '</div>';
    $form['hello_member']['field_date_of_birth']['#weight'] = 10;
    unset($form['field_date_of_birth']);

    $form['field_gender']['widget']['#empty_option'] = t('Select Gender', [], ['context' => 'hello_member']);
    unset($form['field_gender']['widget']['#options']['_none']);
    $form['hello_member']['field_gender'] = $form['field_gender'];
    $form['hello_member']['field_gender']['#prefix'] = '<div class="hello-member-gender">';
    $form['hello_member']['field_gender']['#suffix'] = '</div>';
    $form['hello_member']['field_gender']['#weight'] = 11;
    unset($form['field_gender']);

    $form['actions']['submit']['#value'] = t('Become a Member', [], ['context' => 'hello_member']);
    $form['#attached']['library'][] = 'alshaya_white_label/hello-member-registration';
    $form['#attached']['library'][] = 'alshaya_white_label/convert_to_select2';
  }
}

/**
 * Implements hook_alshaya_my_account_links_alter().
 */
function alshaya_hello_member_alshaya_my_account_links_alter(array &$links) {
  // Do not proceed if Hello member is not enabled.
  if (!\Drupal::service('alshaya_hello_member.hello_member_helper')->isHelloMemberEnabled()) {
    return;
  }

  // Add Points history link.
  $links['hello_member_points_history'] = [
    'text' => t('Points History', [], ['context' => 'hello_member']),
    'route' => 'alshaya_hello_member.hello_member_points_history',
    'weight' => 41,
  ];
  $links['contact_details'] = [
    'text' => t('My Details', [], ['context' => 'hello_member']),
    'route' => 'entity.user.edit_form',
    'weight' => 30,
  ];
}

/**
 * Implements hook_alshaya_user_breadcrumb_routes_alter().
 */
function alshaya_hello_member_alshaya_user_breadcrumb_routes_alter(array &$routes) {
  $routes['alshaya_hello_member.hello_member_points_history'] = [
    'user' => \Drupal::currentUser()->id(),
  ];
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function alshaya_hello_member_form_user_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  /** @var \Drupal\alshaya_hello_member\Helper\HelloMemberHelper */
  $hello_member_helper = \Drupal::service('alshaya_hello_member.hello_member_helper');
  // Only add if hello member enabled and is Edit profile form.
  if (!$hello_member_helper->isHelloMemberEnabled() && $form_id !== 'user_form') {
    return;
  }
  $form['#title'] = t('My Details', [], ['context' => 'hello_member']);
  $form['hello_member'] = [
    '#type' => 'details',
    '#title' => '<div class="hello-member-add-more">' . t('Add More & Get More', [], ['context' => 'hello_member']) . '</div>',
    '#open' => FALSE,
    '#weight' => '5',
  ];
  $form['hello_member']['teasing'] = [
    '#type' => 'markup',
    '#markup' => t('Did you know that if you add some more information below you will earn more points and get a more personalised experience? How great is that?', [], ['context' => 'hello_member']),
    '#prefix' => '<div class="hello-member-accordion-wrapper">',
  ];
  $form['hello_member']['field_date_of_birth'] = $form['field_date_of_birth'];
  $form['hello_member']['field_date_of_birth']['#suffix'] = '<div class="hello-member-gift-info">' . t('H&M wants to give you special treat on your birthday', [], ['context' => 'hello_member']) . '</div>';
  $form['hello_member']['field_date_of_birth']['#weight'] = 10;
  unset($form['field_date_of_birth']);
  $form['field_gender']['widget']['#empty_option'] = t('Select Gender', [], ['context' => 'hello_member']);
  unset($form['field_gender']['widget']['#options']['_none']);
  $form['hello_member']['field_gender'] = $form['field_gender'];
  $form['hello_member']['field_gender']['#prefix'] = '<div class="hello-member-gender">';
  $form['hello_member']['field_gender']['#suffix'] = '</div></div>';
  $form['hello_member']['field_gender']['#weight'] = 11;
  $form['hello_member']['field_mobile_number'] = $form['field_mobile_number'];
  $form['hello_member']['field_mobile_number']['#suffix'] = '<div id="hello-member-send-otp"></div><div id="mobile-number-error"></div>' . t('OTP will be send to your mobile number to verify', [], ['context' => 'hello_member']);
  $form['hello_member']['field_mobile_number']['#weight'] = 12;
  $form['field_verified_otp']['widget']['value']['#ajax'] = [
    'callback' => 'alshaya_hello_member_ajax_opt_verified',
    'wrapper' => 'otp-verified',
    'event' => 'change',
  ];
  unset($form['field_gender']);
  unset($form['field_mobile_number']);
  $form['#attached']['library'][] = 'alshaya_white_label/hello-member-registration';
  $form['#attached']['library'][] = 'alshaya_white_label/convert_to_select2';
  $form['#attached']['library'][] = 'alshaya_hello_member/alshaya_hello_member_send_otp';
}

/**
 * Implements hook_page_title().
 */
function alshaya_hello_member_preprocess_page_title(&$variables) {
  // Do not proceed if Hello member is not enabled.
  if (!\Drupal::service('alshaya_hello_member.hello_member_helper')->isHelloMemberEnabled()) {
    return;
  }

  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'entity.user.canonical') {
    $variables['title'] = t('Benefits', [], ['context' => 'hello_member']);
  }
}

/**
 * Implements hook_alshaya_api_update_customer_api_request_alter().
 */
function alshaya_hello_member_alshaya_api_update_customer_api_request_alter(array &$request_options) {
  // Do not proceed if Hello member is not enabled.
  if (!\Drupal::service('alshaya_hello_member.hello_member_helper')->isHelloMemberEnabled()) {
    return;
  }

  if (isset($request_options['json'], $request_options['json']['customer']['email'])) {
    /** @var \Drupal\user\Entity\User $user */
    $user = user_load_by_mail($request_options['json']['customer']['email']);
    if (!empty($user)) {
      $user_date_of_birth = $user->get('field_date_of_birth')->getString();
      if (!empty($user_date_of_birth)) {
        $request_options['json']['customer']['dob'] = $user_date_of_birth;
      }
      $user_gender = $user->get('field_gender')->getString();
      if (!empty($user_gender)) {
        $request_options['json']['customer']['extension_attributes']['customer_gender'] = $user_gender;
      }
    }
  }
  if ($user->get('field_verified_otp')->getString()) {
    $request_options['json']['customer']['extension_attributes']['is_verified'] = "Y";
    // Set otp verified unchecked to update in future.
    $user->set('field_verified_otp', 0)->save();
  }
  else {
    // If Hello member enable and Mobile number not verified
    // remove it from update customer api request.
    unset($request_options['json']['customer']['extension']['phone_number']);
  }
}

/**
 * Implements hook_block_access().
 */
function alshaya_hello_member_block_access(Block $block, $operation, AccountInterface $account) {
  // Not allow 'page_title_block' or alshaya_my_account_links blocks
  // on my benefit page.
  if ($operation == 'view' && ($block->getPluginId() == 'page_title_block' || $block->getPluginId() == 'alshaya_my_account_links')) {
    $route_name = \Drupal::routeMatch()->getRouteName();

    if ($route_name === 'alshaya_hello_member.hello_member_benefits_page') {
      return AccessResult::forbiddenIf(TRUE);
    }
  }
}

/**
 * Ajax callback: Update verified otp field.
 */
function alshaya_hello_member_ajax_opt_verified(&$form, FormStateInterface $form_state) {
  /** @var \Drupal\user\Entity\User $user */
  $user = user_load_by_mail(\Drupal::currentUser()->getEmail());
  $user->set('field_verified_otp', $form_state->getValue('field_verified_otp')['value'])->save();
}

/**
 * Implements hook_preprocess_page().
 */
function alshaya_hello_member_preprocess_page(&$variables) {
  $route_name = \Drupal::routeMatch()->getRouteName();
  // Hide sidebar region for benefit page.
  if ($route_name === 'alshaya_hello_member.hello_member_benefits_page') {
    unset($variables['page']['sidebar_first']);
  }
}

/**
 * Implements hook_preprocess_html().
 */
function alshaya_hello_member_preprocess_html(&$variables) {
  $route_name = \Drupal::routeMatch()->getRouteName();
  // Add class in body for benefit page.
  if ($route_name === 'alshaya_hello_member.hello_member_benefits_page') {
    $variables['attributes']['class'][] = 'hello-member-benefit-page';
  }
}

/**
 * Implements hook_alshaya_spc_order_details_settings_alter().
 */
function alshaya_hello_member_alshaya_spc_order_details_settings_alter(&$settings, $order) {
  // Do not proceed if Hello member is not enabled.
  if (!\Drupal::service('alshaya_hello_member.hello_member_helper')->isHelloMemberEnabled()) {
    return;
  }

  // Add hello member points for order confirmation.
  if (isset($order['externsion_attributes']['hm_accured_points'])) {
    $settings['order_details']['hmAccuredPoints'] = $order['externsion_attributes']['hm_accured_points'] ?? 0;
  }
}
