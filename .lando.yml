name: alshaya
recipe: drupal8
config:
  composer_version: '1.10.22'
  webroot: docroot

proxy:
  edge:
    - "local.alshaya*.com"
    - edge.acquia.lndo.site

services:
  appserver:
    app_mount: delegated
    type: php:7.3
    ssl: true
    overrides:
      environment:
        DEVEL_ENV: lando
        PHP_IDE_CONFIG: serverName=alshaya
    run_as_root:
      - "apt-get update -y"
      - "apt-get install netcat -y"

  database:
    type: mysql
    portforward: 33061
    run_as_root:
      # Create site databases. TODO: check if we can automate this some other way.
      - /app/.lando/scripts/provision/database.sh

  memcache1:
    type: memcached:1.5.11
    portforward: 11211

  memcache2:
    type: memcached:1.5.11
    portforward: 11212

  edge:
    type: varnish:4.1
    backends:
      - appserver
    ssl: true
    config:
      vcl: architecture/varnish/varnish-4-lando.vcl

  solr:
    type: solr:5.5

  # Images used for tooling.

  node:
    type: node:8

  selenium:
    type: compose
    services:
      image: selenium/standalone-chrome-debug
      # It would be possible to switch to another image,
      # but this has not been tested yet.
      # image: selenium/standalone-firefox-debug

      # If running in headless mode, you may find you
      # need to start XVBF.
      #
      #      environment:
      #        START_XVBF: 'false'
      volumes:
        - /dev/shm:/dev/shm
      command: /opt/bin/entry_point.sh
      ports:
        - '4444:4444'
        - '5900:5900'

tooling:
  blt:
    service: appserver
    cmd: /app/vendor/acquia/blt/bin/blt

  blt-init:
    service: appserver
    description: Initialize BLT aliases, git hooks and settings.
    cmd:
      - appserver: composer blt-alias
      - appserver: blt blt:init:git-hooks
      - appserver: blt blt:init:settings

  frontend-setup:
    service: node
    cmd:  bash /app/blt/scripts/frontend-setup.sh /app/docroot && bash /app/blt/scripts/react-setup.sh /app/docroot

  frontend-build:
    service: node
    cmd:  bash /app/blt/scripts/frontend-build.sh /app/docroot && bash /app/blt/scripts/react-build.sh /app/docroot

  behat-build:
    description: build pre-requisites for behat testing.
    cmd:
      - appserver: cd /app/behat_rework && composer install
      - node: cd /app/behat_rework/bin && npm install
      - appserver: cd /app/behat_rework/ && ./behat-build.sh --rebuild=TRUE

  behat-run:
    description: runs behat tests
    service: appserver
    cmd: cd /app/behat_rework && ./bin/behat -vvv -c behat-lando.yml --format pretty

  xdebug-on:
    service: appserver
    description: Enable xdebug for Apache.
    cmd: docker-php-ext-enable xdebug && service apache2 reload
    user: root

  xdebug-off:
    service: appserver
    description: Disable xdebug for Apache.
    cmd: rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && service apache2 reload
    user: root

excludes:
  - vendor
