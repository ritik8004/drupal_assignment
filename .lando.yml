name: alshaya
recipe: drupal8

config:
  webroot: 'docroot'
  xdebug: true
  php: '7.3'

services:
  database:
    app_mount: disabled
    type: mysql:5.7
    creds:
      user: drupal
      password: drupal
  appserver:
    xdebug: true
    app_mount: delegated
    ssl: true
    type: php:7.3
    composer_version: 1-latest
    build_as_root:
      - bash /app/.lando/scripts/configure-syslog.sh
      - bash /app/.lando/scripts/configure-xhprof.sh
      # Note that you will want to use the script for the major version of node you want to install
      # See: https://github.com/nodesource/distributions/blob/master/README.md#installation-instructions
      - curl -sL https://deb.nodesource.com/setup_8.x | bash -
      - apt-get update -y
      - apt-get install nodejs -y
      - apt-get install netcat -y
    run_as_root:
      # By default disable XDEBUG, we need it enabled to ensure all configurations are loaded.
      # Post this to enable disable lando xdebug-on and lando xdebug-off can be used.
      - rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && service apache2 reload
    overrides:
      environment:
        PHP_IDE_CONFIG: "serverName=alshaya"
  edge:
    app_mount: disabled
    type: varnish:4.1
    backends:
      - appserver
    ssl: true
    config:
      vcl: architecture/varnish/varnish-4-lando.vcl
  memcache:
    app_mount: disabled
    type: memcached:1.5.11
    mem: 64
  pma:
    app_mount: disabled
    type: phpmyadmin
    hosts:
      - database
  mailhog:
    app_mount: disabled
    type: mailhog:v1.0.0
    portforward: false
    hogfrom:
      - appserver
  solr:
    app_mount: disabled
    type: solr:5.5

proxy:
  edge:
    - "*.varnish.alshaya.lndo.site"
  appserver:
    - "*.alshaya.lndo.site"
  pma:
    - "pma-alshaya.lndo.site"
  mailhog:
    - "mail-alshaya.lndo.site"

tooling:
  vim:
    service: myservice
  blt:
    service: appserver
    cmd: /app/vendor/acquia/blt/bin/blt
  xdebug-on:
    service: appserver
    description: Enable xdebug for Apache.
    cmd: docker-php-ext-enable xdebug && service apache2 reload
    user: root
  xdebug-off:
    service: appserver
    description: Disable xdebug for Apache.
    cmd: rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && service apache2 reload
    user: root
  behat-build:
    description: build pre-requisites for behat testing.
    cmd:
      - appserver: cd /app/behat_rework && composer install
      - appserver: cd /app/behat_rework/bin && npm install
      - appserver: cd /app/behat_rework/ && ./behat-build.sh --rebuild=TRUE
  behat-run:
    description: runs behat tests
    service: appserver
    cmd: cd /app/behat_rework && ./bin/behat -vvv -c behat-lando.yml --format pretty
  logs-drupal:
    service: appserver
    description: Displays and tails Drupal logs using syslog module (because drush wd-show no longer supports tail)
    cmd:
      - /app/.lando/scripts/logs-drupal.sh
    user: root

# Exclude those directories which we write a lot on server.
# Content of these directories are usually not required by dev.
excludes:
  - docroot/sites/g/files
  - docroot/middleware/var
  - docroot/appointment/var
  - files-private

events:
  post-start:
    - appserver: /app/.lando/scripts/provision/database.sh
