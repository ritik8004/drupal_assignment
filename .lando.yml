name: alshaya
recipe: drupal8

config:
  webroot: 'docroot'
  xdebug: true
  php: '7.3'

services:
  database:
    app_mount: disabled
    type: mysql:5.7
    creds:
      user: drupal
      password: drupal
  appserver:
    xdebug: true
    app_mount: delegated
    ssl: true
    type: php:7.3
    composer_version: 1-latest
    build_as_root:
      # Note that you will want to use the script for the major version of node you want to install
      # See: https://github.com/nodesource/distributions/blob/master/README.md#installation-instructions
      - curl -sL https://deb.nodesource.com/setup_8.x | bash -
      - apt-get update -y
      - apt-get install nodejs -y
      - apt-get install netcat -y
      - apt-get install vim -y
      # We want to remove drupal.log so it doesn't get too big,
      # but we want to allow rsyslog to create it so it has correct permissions.
      - rm -f /var/logs/drupal.log
      - apt-get install rsyslog -y
      - cat /app/.lando/config/rsyslog.conf > /etc/rsyslog.d/50-default.conf
    run_as_root:
      # By default disable XDEBUG, we need it enabled to ensure all configurations are loaded.
      # Post this to enable disable lando xdebug-on and lando xdebug-off can be used.
      - rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && service apache2 reload
    overrides:
      environment:
        DEVEL_ENV: lando
        PHP_IDE_CONFIG: "serverName=alshaya"
  edge:
    app_mount: disabled
    type: varnish:4.1
    backends:
      - appserver
    ssl: true
    config:
      vcl: .lando/config/varnish-4.vcl
  memcache:
    app_mount: disabled
    type: memcached:1.5.11
    mem: 64
  pma:
    app_mount: disabled
    type: phpmyadmin
    hosts:
      - database
  mailhog:
    app_mount: disabled
    type: mailhog:v1.0.0
    portforward: false
    hogfrom:
      - appserver
  solr:
    app_mount: disabled
    type: solr:5.5

proxy:
  edge:
    - "*.varnish.alshaya.lndo.site"
  appserver:
    - "*.alshaya.lndo.site"
  pma:
    - "pma-alshaya.lndo.site"
  mailhog:
    - "mail-alshaya.lndo.site"

tooling:
  blt:
    service: appserver
    cmd: /app/vendor/acquia/blt/bin/blt
  blt-init:
    service: appserver
    description: Initialize BLT aliases, git hooks and settings.
    cmd:
      - appserver: composer blt-alias
      - appserver: blt blt:init:git-hooks
      - appserver: blt blt:init:settings
  xdebug-on:
    service: appserver
    description: Enable xdebug for Apache.
    cmd: docker-php-ext-enable xdebug && service apache2 reload
    user: root
  xdebug-off:
    service: appserver
    description: Disable xdebug for Apache.
    cmd: rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && service apache2 reload
    user: root
  behat-build:
    description: build pre-requisites for behat testing.
    cmd:
      - appserver: cd /app/behat_rework && composer install
      - appserver: cd /app/behat_rework/bin && npm install
      - appserver: cd /app/behat_rework/ && ./behat-build.sh --rebuild=TRUE
  behat-run:
    description: runs behat tests
    service: appserver
    cmd: cd /app/behat_rework && ./bin/behat -vvv -c behat-lando.yml --format pretty
  logs-drupal:
    service: appserver
    description: Displays and tails Drupal logs using syslog module (because drush wd-show no longer supports tail)
    cmd:
      - /app/.lando/scripts/logs-drupal.sh
    user: root

excludes:
  - docroot/themes/custom/transac/node_modules
  - docroot/themes/custom/non_transac/node_modules
  - docroot/themes/custom/amp/node_modules
  - docroot/themes/custom/transac_lite/node_modules
  - docroot/modules/react/node_modules
  - docroot/libraries

events:
  post-start:
    - appserver: /app/.lando/scripts/provision/database.sh
