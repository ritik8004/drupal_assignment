# New Behat Architecture

 - [Local setup](#cloud-setup) :anchor:
 - [Important file and variable](#bell-important-variable) :anchor:
 - [Guide lines for using variables format](#book-guide-lines-for-using-variables-format) :anchor:

## :cloud: Setup

- Check if `jdk` is installed and running on your machine.
- `java --version` To check the java is installed.
Otherwise install it via brew or from java:
[https://www.java.com/en/download/help/index_installing.xml](https://www.java.com/en/download/help/index_installing.xml)

1. `cd tests/behat` :file_folder:
2. `composer install` :hourglass_flowing_sand:
3. `cd bin; npm install` :gear:
4. `cd ..`
5. `./behat-build.sh --rebuild=TRUE` This will generate feature files :rocket:.
  - parameters:
    - `--rebuild` (boolean): `TRUE` to recollect yml files and variables.
      - by default rebuild is false, and it will only regenerate features files
        based on already collected variables.
        (It won't include any new variables.)
    - `--site` parameter supports comma separated values:
      - only brand name: `--site=hm,mc`
      - brand + market: `--site=hm-kw,hm-sa`
      - brand + market + env: `--site=hm-kw-uat,hm-sa-uat`
      - brand + market + env + lang: `--site=hm-kw-uat-en,hm-sa-uat-ar`
  - :bell: :bell:
  **NOTE: If you have modified only existing features file and "not" modified or placed any
  new variables you can simply execute `./behat-build.sh`.**
6. (In a separate terminal window) :computer:
```bash
java -Dwebdriver.chrome.driver=bin/node_modules/chromedriver/bin/chromedriver -jar vendor/se/selenium-server-standalone/bin/selenium-server-standalone.jar
```
7. The script that we ran on point 5, Has generated different profiles for each site with brand, env and language specific. i.e. = mc-sa-qa-ar, mc-sa-qa-en, hm-kw-dev-en etc..
to Run behat test cases for:
 - any specific site for desktop - `bin/behat --profile=hm-kw-uat-en-desktop` :fire:
 - any specific site for mobile - `bin/behat --profile=hm-kw-uat-en-mobile` :fire:
 - any specific tag for a site for desktop - `bin/behat --profile=hm-eg-dev2-en-desktop --format pretty --tags="language"` :fire:
 - any specific tag for a site for mobile - `bin/behat --profile=hm-eg-dev2-en-mobile --format pretty --tags="language"` :fire:
 - any specific feature for a site for desktop - `bin/behat --profile=hm-kw-uat-en-desktop build/features/hm-kw-uat-en/breadcrumb.feature` :fire: :fire:
 - any specific feature for a site for mobile - `bin/behat --profile=hm-kw-uat-en-mobile build/features/hm-kw-uat-en/breadcrumb.feature` :fire: :fire:
 - any specific tag in a feature for desktop - `bin/behat --profile=hm-eg-dev2-en-desktop --format pretty build/features/hm-eg-dev2-en/spcbasket.feature --tags="language"` :fire:
 - any specific tag in a feature for mobile - `bin/behat --profile=hm-eg-dev2-en-mobile --format pretty build/features/hm-eg-dev2-en/spcbasket.feature --tags="language"` :fire:
 - any specific language for a feature for desktop - `bin/behat --profile=hm-eg-dev2-en-desktop build/features/hm-eg-dev2-en/spcbasket.feature --format pretty --tags="~language"` :fire:
 - any specific language for a feature for mobile - `bin/behat --profile=hm-eg-dev2-en-mobile build/features/hm-eg-dev2-en/spcbasket.feature --format pretty --tags="~language"` :fire:


# Alshaya Behat Architecture

The idea behind this custom architecture is to avoid duplication of feature
files and maintaining feature files for multi-sites.

## :scroll: Directory Structure

Inside `tests/behat` directory:
```text

    ├── bin
    ├── build          # Compiled files by behat-build.sh
    ├── files          # Contains media files.
    ├── src            # Code files that generate .feature files from templates
    ├── templates      # Contains templates (We (Developer/QA) use This folder)
    ├── vendor         # Generated by composer
    ├── behat-build.sh
    ├── behat.yml
    └── README.md

```

### :clipboard: Inside `/templates/variables`

Here's what actual structure will look like.

```text
    .
    ├── ...
    ├── templates
    │   ├── behat.yml
    │   ├── features
    │   ├── variables
    │   │   ├── common.yml
    │   │   ├── languages
    │   │   │   ├── en.yml
    │   │   │   ├── ar.yml
    │   │   ├── markets
    │   │   │   ├── kw.yml
    │   │   │   ├── sa.yml
    │   │   ├── brands
    │   │   │   ├── hm
    │   │   │   │   ├── hm.yml
    │   │   │   │   ├── languages
    │   │   │   │   │   ├── en.yml
    │   │   │   │   │   ├── ar.yml
    │   │   │   │   ├── markets
    │   │   │   │   │   ├── kw
    │   │   │   │   │   │   ├── kw.yml
    │   │   │   │   │   │   ├── languages
    │   │   │   │   │   │   │   ├── en.yml
    │   │   │   │   │   │   │   ├── ar.yml
    │   │   │   │   │   ├── sa
    │   │   │   │   │   │   ├── sa.yml
    │   │   │   │   ├── env
    │   │   │   │   │   ├── qa
    │   │   │   │   │   │   ├── qa.yml
    │   │   │   │   │   │   ├── markets
    │   │   │   │   │   ├── uat
    │   │   │   │   │   │   ├── uat.yml
    │   │   │   │   │   │   ├── languages
    │   │   │   │   │   │   │   ├── en.yml
    │   │   │   │   │   │   │   ├── ar.yml
    │   │   │   │   │   │   ├── markets
    │   │   │   │   │   │   │   ├── kw
    │   │   │   │   │   │   │   │   ├── kw.yml
    │   │   │   │   │   │   │   │   ├── languages
    │   │   │   │   │   │   │   │   │   ├── en.yml
    │   │   │   │   │   │   │   │   │   ├── ar.yml
    │   │   │   ├── mc
    │   │   │   ├── vs
    └── └── └── └── ...
```

#### :memo: Here are the files and naming convention of `*.yml` files to use:
1. Inside `variables` directory there's a `common.yml` file.
2. at the same level as `common.yml` there are three folders:
  ```text
   - languages
   - markets
   - brands
  ```
3. `markets` directory there are folders, containing name like 2 characters
of country code, and inside that folder there's a `*.yml` file, contains
country code of 2 characters. (`kw/kw.yml`, `ae/ae.yml`, `sa/sa.yml`)
4. `languages` directory, there are files with lang code `en.yml, ar.yml`.
5. `brands` directory, there are folders with brand name (`hm`, `mc`) and
inside that folder `hm.yml, mc.yml` files respectively.
 - Inside `brands` directory, there are three folders,
   ```text
   - languages
   - markets
   - env
   ```
  - `markets` folder have directories and `*.yml` file as described in third
  step.
  - `env` dir contains envs folders `qa, uat, pprod` etc.
    - Inside `env` folder it contains
      - `yml` file with env name. (`qa.yml, uat.yml`) etc.
      - And also contains folders `languages, markets`
        - `languages` folder contains files as described in fourth step.
        - `markets` folder contains files as described in third step.

So, for example: `hm-kw-uat-en` site these files picked up in following order:

```text
templates/variables/common.yml
templates/variables/languages/en.yml
templates/variables/markets/kw.yml
templates/variables/brands/hm/hm.yml
templates/variables/brands/hm/languages/en.yml
templates/variables/brands/hm/markets/kw/kw.yml
templates/variables/brands/hm/markets/kw/languages/en.yml
templates/variables/brands/hm/env/uat/uat.yml
templates/variables/brands/hm/env/uat/languages/en.yml
templates/variables/brands/hm/env/uat/markets/kw/kw.yml
templates/variables/brands/hm/env/uat/markets/kw/languages/en.yml
```

### :bell: IMPORTANT Variable:
Following file and variable is must, for any given environment.
*For each enabled languages* (If a site has two language EN and AR):
- *`templates/variables/brands/{brand}/env/uat/markets/kw/languages/en.yml`*
- *`templates/variables/brands/{brand}/env/uat/markets/kw/languages/ar.yml`*

And these files must contain `url_base_uri` inside `variables:`. i.e.
```yaml
variables:
  url_base_uri: 'https://hmkw-uat.factory.alshaya.com/en'
```
:bangbang: **Without this variable it won't generate profile and feature files for that
specific brand and env.** :bangbang:


#### :book: Guide lines for using variables format:
- `.yml` files contains `variables`, `tests` and `tags` keys. `variables` are
used to replace token, Which we wrote in feature files with curly braces
(i.e. `{var_userame}`), inside `template/features/*/*.feature` files.
**_variables must start with `var_` prefix._**

Here's an example of a sample `*.yml` file.
```yaml
variables:                         # Contains variables to replace with token
  var_username: 'kw-common@acquia.com'
  var_password: 'Common@123.com'
tests:                             # Contains a list of features to run.
  - 'login'                        # these contains real (*.feature) file names
  - 'sign-in'                      # without file extension.
tags:              # list of tags that you want to replace with {@tags}
  - 'hm'
  - 'kw'
  - 'uat'
```
-  `Languages` folder is used to store language specific urls and variables.
like: page url, currency etc...
**_variables must start with `lang_` or `url_` prefix._**

Here's an examples of a sample `*.yml` file inside languages folder.

> `en.yml`
> ```yaml
> variables:
>   lang_sing_in_txt: 'sign in'
>   lang_sing_in_btn: 'Sign In'
>   url_login_link: '/user/login'  # without language prefix
>   url_product_link: '/product/any-dummy-product' # without language prefix
> ```
> `ar.yml`
> ```yaml
> variables:
>  lang_sing_in_txt: 'تسجيل الدخول'
>  lang_sing_in_btn: 'تسجيل الدخول'
>  url_login_link: '/user/login' # without language prefix
>  url_product_link: '/حلمات--من-تدفق-متوسط-عبوة-من-قطعتين'
> ```

#### :label: behat `tags` in `*.yml`

Add a `tags` :label: key in `*.yml` file as shown in above sample and add as many tags
as you want to add as a list.

Here's how you use tags in your `*.feature` file.

```text
@signup @liveonly {@tags}
Scenario: As an authenticated user,
  I should be able to sign in after providing valid credentials
    Given I am on homepage
    And I initialize multilingual context
    And I wait for the page to load
    When I close the popup
    And I wait for the page to load
    And I go to "{url_login_url}"
```

add your custom tags for each scenario or feature inside the `*.feature` file
as show in above example (`@signup @liveonly`), after that add `{@tags}`
variable.

:bell: :bell:
**NOTE: use `{@tags}` for only common tags, it means all the tags that you
list in `*.yml` file will be replaced with `{@tags}` in all places.**

#### writing variable for behat `table` format in `*.yml`

For example, you want to create feature with `Examples:`
```text
  Scenario Outline: As a guest
  I should be able to view breadcrumbs across the site
    Given I am on "<page>"
    And I wait for the page to load
    Then the breadcrumb "<breadcrumb>" should be displayed
  Examples:
      | page                         | breadcrumb                             |
      | /ladies                      | Home > Ladies                          |
      | /ladies/new-arrivals/clothes | Home > Ladies > New Arrivals > Clothes |
      | /cart                        | Home > Basket                          |
```
OR

```text
Scenario:
  Given the following people exist:
    | name  | email           | phone |
    | Aslak | aslak@email.com | 123   |
    | Joe   | joe@email.com   | 234   |
    | Bryan | bryan@email.org | 456   |
```

Replace the table with variable like:
```text
Examples:
  {var_breadcrumb_table}
```
OR
```text
Given the following people exist:
  {var_people_table}
```

Define the variable as shown below in your `*.yml` file:
```yaml
variables:
  var_breadcrumb_table:
    1:                        # Row, this can be any number, it doesn't matter.
      - page                  # column #1 title
      - breadcrumb            # column #2 title
    2:
      - '/ladies'             # column #1 value
      - 'Home > Ladies'       # column #2 value
    3:
      - '/ladies/new-arrivals/clothes'
      - 'Home > Ladies > New Arrivals > Clothes'
    5:
      - '/cart'
      - 'Home > Basket'
```

### Adding a new brand to the suite

Please follow the below instructions to add a new brand into the site.
1. Inside `variables\brands` directory add brand using naming convention i.e brandname say `aeo`.
2. Add following directories inside the new brand i.e `env`, `languages`, `markets` and the yaml file i.e `brandname.yml` say `aeo.yml`.
3. Next, under the brand directory add different environments avialble for the new brand example `dev2, pprod, uat, qa, prod` etc.
4. Under each environment directory add a folder `markets`. In those add each region available for that brand example `ae`, `sa`, `kw` etc
5. Under each region you can have two yaml files i.e `en.yml` and `ar.yml` inside the directory `languages` for the langauges
available and a yaml file i.e say `ae.yml` containing the variables and its values for that brand needed to run the tests.
6. Inside `bootstrap` directory under the `Drupal` directory add the new brand directory example `aeo`.
7. Now, add a subcontext file using naming convenstion `brandnameContext.behat.inc` example `aeoContext.behat.inc` or
make a copy of `bpContext.behat.inc` using naming convenstion `brandnameContext.behat.inc` example `aeoContext.behat.inc`.
8. Add custom steps for the brand inside this subContext file.
9. Lastly, add the tags for prod and pprod site based on the tests that you would like to run on production site or preproduction site
using naming convention i.e `brandnameRegionEnvironment` example `aeoaeprod` in the .feature files that can be found under path `templates\features\common\prod`

### Inside `/templates/features`

Features folder contains only `*.feature` files and as the name suggests, These
are used as templates for actual feature files. so, these `*.feature` files
usually contains variables in curly braces (`{var_username}, {var_product_url},
{var_promo_block_title}` etc.) instead of actual value.

Here's a sample *.feature file:
```text
  Scenario: As an authenticated user,
  I should be able to sign in after providing valid credentials
    Given I am on homepage
    And I wait for the page to load
    When I close the popup
    And I wait for the page to load
    And I go to "{url_login}"
    When I fill in "edit-name" with "{var_username}"
    And I fill in "edit-pass" with "{var_password}"
    And I press "sign in"
    Then I should see the link "{lang_my_account_txt}"
    And I should see the link "{lang_sign_out_txt}"
    And I should see "{lang_recent_orders_txt}"
```

Here's the directory structure:
```text
    .
    ├── ...
    ├── templates
    │   ├── features
    │   │   ├── common                   # common feature files for all sites.
    │   │   │   ├── login.feature
    │   │   │   ├── contact.feature
    │   │   │   ├── advanced-page.feature
    │   │   │   ├── store-finder.feature
    │   │   ├── hm                       # common features for H&M brand
    │   │   │   ├── contact.feature
    │   │   │   ├── kw                   # features for H&M kuwait for all envs
    │   │   │   │   ├── login.feature
    │   │   │   │   ├── sign-up.feature
    │   │   │   │   ├── uat              # env specific feature.
    │   │   │   │   │   ├── login.feature
    │   │   │   ├── sa
    │   │   │   │   ├── login.feature
    │   │   │   │   ├── contact.feature
    │   ├── variables
    │   └── behat.yml
    └── ...

```
## Running test suite from Local environment to any environment

Please follow the below steps for Running tests on local
Note: Make sure your chrome browser is at the latest version
1. `cd tests/behat`
2. `git pull upstream develop`
3. `composer install` or `composer update`
4. `cd bin; npm install`
5. `cd ..`
6. In common.yml file add the following variables with the account details you want to run the tests with: (can be use one username/password for all)
    1. spc_auth_user_email
    2. spc_auth_user_password
    3. spc_new_registered_user_email
    4. spc_new_registered_user_password
    5. spc_returning_user_email
    6. spc_returning_user_password
    7. spc_mada_anon_username
    8. spc_full_name
    9. anon_email
    10. anon_username
    11. boots_user_email
    12. boots_user_password
    13. boots_auth_firstname
    14. boots_auth_lastname
    15. boots_auth_email

For example :-  anon_username: 'Sample User Name'
7. Run the following command:
`./behat-build.sh --rebuild=TRUE`
8. (In a separate terminal window) run the command-
`java -Dwebdriver.chrome.driver=bin/node_modules/chromedriver/bin/chromedriver -jar vendor/se/selenium-server-standalone/bin/selenium-server-standalone.jar`
9. Run the scripts using these commands for example for UAT environment:
    1. For H&M -
        1. `bin/behat --profile=hm-kw-uat-en-desktop`
        2. `bin/behat --profile=hm-ae-uat-en-desktop`
        3. `bin/behat --profile=hm-sa-uat-en-desktop`
    2. FL
        1. `bin/behat --profile=fl-kw-uat-en-desktop`
        2. `bin/behat --profile=fl-sa-uat-en-desktop`
        3. `bin/behat --profile=fl-ae-uat-en-desktop`
    Similarly for Prod sites we can use these commands:
    3. VS
        1. `bin/behat --profile=vs-ae-prod-en-desktop`
        2. `bin/behat --profile=vs-sa-prod-en-desktop`
    4. MC
        1. `bin/behat --profile=mc-kw-prod-en-desktop`
        2. `bin/behat --profile=mc-sa-prod-en-desktop`
        3. `bin/behat --profile=mc-ae-prod-en-desktop`
    Similarly for pprod sites we can use these commands:
    5. BBW
        1. `bin/behat --profile=bbw-kw-pprod-en-desktop`
        2. `bin/behat --profile=bbw-sa-pprod-en-desktop`
        3. `bin/behat --profile=bbw-ae-pprod-en-desktop`
    6. PB
        1. `bin/behat --profile=pb-kw-pprod-en-desktop`
        2. `bin/behat --profile=pb-ae-pprod-en-desktop`
        3. `bin/behat --profile=pb-sa-pprod-en-desktop`
        
**Please Note**:

For testing the functionalities like New Checkout and New Pdp the following variables need to be set as TRUE or 1 in the yaml files where the functionality is available.

**Variables:**

*For New PDP:*
```text
  new_pdp_enabled: TRUE
```
*For New Checkout:*
```text
new_checkout_enabled: TRUE
```
For example: The New PDP functionality is available on HM-SA on QA environment (i.e H&M brand for QA environment under SA Region) then this functionality can be tested via setting the new pdp variable in sa.yml file that can found under H&M brand QA environment SA region, then the yaml file should look like:
```text
variables:
  new_pdp_enabled: TRUE
```
OR 
```text
variables:
  new_pdp_enabled: 1
```
Similarly, new checkout functionality can be tested via setting the variable.