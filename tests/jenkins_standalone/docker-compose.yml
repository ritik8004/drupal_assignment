# Stack used to run composer commands and behat tests
# This will work only with remote sites
# References
# https://github.com/cieplakm/playground/blob/d5150e10b63aec38694d4916cc56363ce1efc6b7/jenkins/Dockerfile
# https://github.com/stevelle/jenkins-rpc/blob/40c3147643041e69574266a3453a8e1973ad616d/dockerfiles/jenkins/Dockerfile
# https://github.com/search?l=&o=desc&q=from+ubuntu+jenkins+filename%3ADockerfile+language%3ADockerfile+language%3ADockerfile%22&s=indexed&type=Code
version: '3'

services:

  jenkins:
    container_name: ${PROJECT_NAME}
    build:
      context: ./
      dockerfile: Dockerfile-Jenkins
    volumes:
      # https://devopscube.com/run-docker-in-docker/#:~:text=To%20run%20docker%20inside%20docker,sock%20as%20a%20volume.&text=Just%20a%20word%20of%20caution,privileges%20over%20your%20docker%20daemon.
      - /var/run/docker.sock:/var/run/docker.sock
      # Map jenkins_home to keep all data
      - ./jenkins_home:/var/jenkins_home
      # Map for cucumber reports
      - ../behat/build/cucumber:/tmp/cucumber
    environment:
      # Disable setup wizard.
      JAVA_OPTS: -Djenkins.install.runSetupWizard=false
      BEHAT_SECRET_KEY: ${BEHAT_SECRET_KEY}
    ports:
      - '8080:8080'
      - '50000:50000'

  browser:
    # https://github.com/SeleniumHQ/docker-selenium
    # Container can be viewed with VNC port 5901
    # Password: secret
#    image: selenium/standalone-chrome:beta
    image: selenium/standalone-chrome-debug:3.141.59-xenon
    shm_size: 2gb
    container_name: ${PROJECT_NAME}_browser
    ports:
      - '4444:4444'
      - '5901:5900'

  appserver:
    build:
      context: ./
      dockerfile: Dockerfile-AppServer
    container_name: ${PROJECT_NAME}_appserver
    environment:
      DOCKER_JENKINS: 1
      PHP_MEMORY_LIMIT: "1G"
      PHP_CLI_MEMORY_LIMIT: "1G"
      PHP_APCU_ENABLED: 1
      PHP_APCU_SHM_SIZE: 512M
    volumes:
      - ../behat:/behat
