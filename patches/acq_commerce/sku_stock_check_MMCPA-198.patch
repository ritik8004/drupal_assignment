From 90e165cdb87afb2692aa85dadd62cb265996ef2b Mon Sep 17 00:00:00 2001
From: Rohit Joshi <joshi.rohit100@gmail.com>
Date: Tue, 25 Apr 2017 17:15:22 +0530
Subject: [PATCH] MMCPA-198: Adding utility to check the tock for given SKU.

---
 .../config/install/acq_commerce.conductor.yml      |  1 +
 .../acq_commerce/src/Conductor/APIWrapper.php      | 41 ++++++++++++++++++++++
 2 files changed, 42 insertions(+)

diff --git a/docroot/modules/commerce/acq_commerce/config/install/acq_commerce.conductor.yml b/docroot/modules/commerce/acq_commerce/config/install/acq_commerce.conductor.yml
index 96ee50e..32374dd 100644
--- a/docroot/modules/commerce/acq_commerce/config/install/acq_commerce.conductor.yml
+++ b/docroot/modules/commerce/acq_commerce/config/install/acq_commerce.conductor.yml
@@ -3,3 +3,4 @@ url_ingest: ''
 timeout: 30
 verify_ssl: true
 product_page_size: 50
+stock_check_cache_proportion: 10
diff --git a/docroot/modules/commerce/acq_commerce/src/Conductor/APIWrapper.php b/docroot/modules/commerce/acq_commerce/src/Conductor/APIWrapper.php
index 9ca1074..5e37081 100644
--- a/docroot/modules/commerce/acq_commerce/src/Conductor/APIWrapper.php
+++ b/docroot/modules/commerce/acq_commerce/src/Conductor/APIWrapper.php
@@ -51,6 +51,47 @@ public function createCart($customer_id = NULL) {
   }
 
   /**
+   * Checks the stock for the given sku.
+   *
+   * @param string $sku
+   *   The sku id.
+   *
+   * @return array|mixed
+   *   Available stock detail.
+   *
+   * @throws \Exception
+   */
+  public function skuStockCheck($sku) {
+    $endpoint = "stock/$sku";
+
+    $doReq = function ($client, $opt) use ($endpoint) {
+      return ($client->get($endpoint, $opt));
+    };
+
+    $stock = [];
+
+    try {
+      // Cache id.
+      $cid = 'stock:' . $sku;
+
+      // If information is cached.
+      if ($cache = \Drupal::cache('data')->get($cid)) {
+        $stock = $cache->data;
+      }
+      else {
+        $stock = $this->tryAgentRequest($doReq, 'skuStockCheck', 'stock');
+        $stock_check_proportion = \Drupal::config('acq_commerce.conductor')->get('stock_check_cache_proportion');
+        \Drupal::cache('data')->set($cid, $stock, $stock['quantity'] * $stock_check_proportion);
+      }
+    }
+    catch (ConductorException $e) {
+      throw new \Exception($e->getMessage(), $e->getCode());
+    }
+
+    return $stock;
+  }
+
+  /**
    * Gets the user cart from a cart ID.
    *
    * @param int $cart_id
