# Note that the example .travis.yml file for child projects lives in /install.
# Temporarily use legacy infrastructure until Travis resolves MySQL issues with their containerized infrastructure.
# @see https://github.com/travis-ci/travis-ci/issues/6842
sudo: required
language: php
dist: trusty

matrix:
  fast_finish: true
  include:
  - php: 7.3
    env:
      - INSTALL_TYPE=install
      - PROFILE=alshaya_transac
    if: type IN (pull_request, cron)
  - php: 7.3
    env:
      - INSTALL_TYPE=install
      - PROFILE=alshaya_non_transac
    if: type IN (pull_request, cron)
  #- php: 7.3
  #  env:
  #  - INSTALL_TYPE=update
  #  - PROFILE=alshaya_transac
  #  if: type = pull_request
  #- php: 7.3
  #  env:
  #  - INSTALL_TYPE=update
  #  - PROFILE=alshaya_non_transac
  #  if: type = pull_request
  - php: 7.3
    if: type = push

env:
  global:
    - COMPOSER_BIN=$TRAVIS_BUILD_DIR/vendor/bin
    - BLT_DIR=$TRAVIS_BUILD_DIR/vendor/acquia/blt
    - BUILD_DIR=$TRAVIS_BUILD_DIR

jdk:
  - oraclejdk8

cache:
  bundler: true
  apt: true
  directories:
  - "$HOME/.composer/cache"
  - "$HOME/.drush/cache"
  - "$HOME/.npm"
  - "$HOME/.nvm"
  - "vendor"
  - "docroot/middleware/vendor"
  - "docroot/modules/contrib"
  - "docroot/themes/contrib"
  - "docroot/profiles/contrib"
  - "docroot/core"
  - "docroot/libraries"
  - "docroot/themes/custom/amp/node_modules"
  - "docroot/themes/custom/non_transac/node_modules"
  - "docroot/themes/custom/transac/node_modules"

addons:
  ssh_known_hosts:
  - svn-6182.devcloud.hosting.acquia.com
  - svn-25.enterprise-g1.hosting.acquia.com

# @see https://docs.travis-ci.com/user/notifications
notifications:
  slack:
    secure: "QW/vcMfCY0FtGTzNJrtnG32uOgmOfrgaFeo68inAcrMQaesAWpppJVG5C4guOwHiYMoaZR3wbQA0cecho7XYTUILrFCEuWRQ/+T7zMs+lg69AYj2HGvq3Ef+Wn16TkdSZFShKZwFd9cPjqCaPVPJ994HEKxWqw5p1q0xzLme10y4Fk7TphpnhqW+6Z8JADY9WQ/YgtCOsrwOMuSsgsP7uKFJFCIVwLcg2o7JukBjY67hOceFfhxpC1gC/b7ohHlDZfn8owbzZazRCTKEEJM1KBc3s0APXBwjqh/l4laGRqB6PGCSR2TwhvfD2z9ZF6woicOZNT9kbK1iWQ0gT824gmM6FiEG9I+Skwnvc0QkavIccYEuwV4yOtzk2Eh3vcBNrPItN3g05nNL1zk+S2eTNG7olB0/fG18rHiqaUozIIRabbPr2FVBc7jQeLzSJ3oi7zPQRPFG39tkRncvDnj9S4V6gQE+BKFGHhXRCMK8/UASLhK5IASuO+4OPwZMxXtLUZsOD+bNSsZFhtG2J35dGl3PrBWJ1gGY1wBiEzEErmH3bgi79XNSNQONrJ2wFffriP+4cRuZGJ8w/+AwZYvDnpfCIKfKlASmJ4vHx1ILCPKXlAWnuobekHyCukEElvKkfiFgkjVIYpfINz5QpCkcWln8Hu4sifAkfPNf2oq8hn4="

before_install:
  # Disable xdebug.
  - phpenv config-rm xdebug.ini
  - composer self-update
  - git config --global github.accesstoken "${GITHUB_OAUTH_TOKEN}"
  - composer validate --no-check-all --ansi
  - source ${BUILD_DIR}/blt/scripts/delete_composer_caches "${BUILD_DIR}"
  # There seems to be stronger rate limiting applied to Github downloads
  # that forces us to retry composer install several times.
  # Symptom is a Github download ending with 404 while the URL is valid.
  - composer install --no-interaction || composer install --no-interaction || composer install --no-interaction || composer install --no-interaction
  # Build middleware.
  - source ${BUILD_DIR}/blt/scripts/middleware-build.sh "${BUILD_DIR}/docroot/middleware"
  # Build appointment middleware.
  - source ${BUILD_DIR}/blt/scripts/middleware-build.sh "${BUILD_DIR}/docroot/appointment"
  # Exit build early if only documentation was changed in a Pull Request.
  - source ${BLT_DIR}/scripts/travis/exit_early

install:
  - source ${BLT_DIR}/scripts/travis/setup_environment
  - chmod 600 ${BUILD_DIR}/private/travis_acm.pub
  - echo "memory_limit=576M" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
  - echo "extension = memcached.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - source $BLT_DIR/scripts/travis/setup_project
  - nvm install 8.12.0
  - nvm use 8.12.0
  - npm install -g gulp-cli
  # Setup the themes here so the node_modules folders can be cached.
  - source ${BUILD_DIR}/blt/scripts/frontend-setup.sh "${BUILD_DIR}/docroot"
  # Frontend-setup.sh changed directory, hence we return to the original dir.
  - cd ${BUILD_DIR}

script:
  # Changing path to disable behat test on Travis.
  # - source $BLT_DIR/scripts/travis/run_tests
  - source ${BUILD_DIR}/blt/scripts/run_tests

deploy:
  - provider: script
    script: ${BUILD_DIR}/blt/scripts/deploy_branch.sh
    skip_cleanup: true
    on:
      all_branches: true
      tags: false
      php: 7.3
  - provider: script
    script: "$BLT_DIR/scripts/travis/deploy_tag"
    skip_cleanup: true
    on:
      tags: true
      php: 7.3
