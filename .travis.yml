# Note that the example .travis.yml file for child projects lives in /install.
# Temporarily use legacy infrastructure until Travis resolves MySQL issues with their containerized infrastructure.
# @see https://github.com/travis-ci/travis-ci/issues/6842
sudo: required
language: php
dist: trusty

php:
  - 7.1

matrix:
  fast_finish: true

env:
  global:
    - COMPOSER_BIN=$TRAVIS_BUILD_DIR/vendor/bin
    - BLT_DIR=$TRAVIS_BUILD_DIR/vendor/acquia/blt
    - BUILD_DIR=$TRAVIS_BUILD_DIR

jdk:
  - oraclejdk8

cache:
  bundler: true
  apt: true
  directories:
  - "$HOME/.composer/cache"
  - "$HOME/.drush/cache"
  - "$HOME/.npm"
  - "$HOME/.nvm"
  - "vendor"
  - "docroot/themes/custom/amp/alshaya_amp_hnm/node_modules"
  - "docroot/themes/custom/amp/alshaya_amp_mothercare/node_modules"
  - "docroot/themes/custom/amp/alshaya_amp_victoria_secret/node_modules"
  - "docroot/themes/custom/amp/alshaya_amp_white_label/node_modules"
  - "docroot/themes/custom/non_transac/bath_body_works/node_modules"
  - "docroot/themes/custom/non_transac/bouchon_bakery/node_modules"
  - "docroot/themes/custom/non_transac/debenhams/node_modules"
  - "docroot/themes/custom/non_transac/victoria_secret/node_modules"
  - "docroot/themes/custom/non_transac/whitelabel/node_modules"
  - "docroot/themes/custom/non_transac/whitelabel_non_transac/node_modules"
  - "docroot/themes/custom/transac/alshaya_bathbodyworks/node_modules"
  - "docroot/themes/custom/transac/alshaya_example_subtheme/node_modules"
  - "docroot/themes/custom/transac/alshaya_hnm/node_modules"
  - "docroot/themes/custom/transac/alshaya_mothercare/node_modules"
  - "docroot/themes/custom/transac/alshaya_pottery_barn/node_modules"
  - "docroot/themes/custom/transac/alshaya_victoria_secret/node_modules"
  - "docroot/themes/custom/transac/alshaya_white_label/node_modules"
  - "docroot/themes/custom/transac/pottery_barn_non_trans/node_modules"

addons:
  ssh_known_hosts:
  - svn-6182.devcloud.hosting.acquia.com
  - svn-25.enterprise-g1.hosting.acquia.com

# @see https://docs.travis-ci.com/user/notifications
notifications:
# - hipchat: [api token]@[room id or name]
# - slack: '<account>:<token>#[channel]'

before_install:
  # Disable xdebug.
  - phpenv config-rm xdebug.ini
  - composer self-update
  - composer validate --no-check-all --ansi
  - composer install
  # Exit build early if only documentation was changed in a Pull Request.
  - source ${BLT_DIR}/scripts/travis/exit_early

install:
  - source ${BLT_DIR}/scripts/travis/setup_environment
  - echo "memory_limit=512M" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
  - echo "extension = memcached.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - source $BLT_DIR/scripts/travis/setup_project
  - nvm install 6.10.0
  - nvm use 6.10.0

script:
# Changing path to disable behat test on Travis.
# - source $BLT_DIR/scripts/travis/run_tests
  - source ${BUILD_DIR}/blt/scripts/run_tests

deploy:
   - provider: script
     script: "$BLT_DIR/scripts/travis/deploy_branch"
     skip_cleanup: true
     on:
       branch: develop
       php: 7.1
   - provider: script
     script: "$BLT_DIR/scripts/travis/deploy_branch"
     skip_cleanup: true
     on:
       branch: acm-v2-ps
       php: 7.1
   - provider: script
     script: "$BLT_DIR/scripts/travis/deploy_branch"
     skip_cleanup: true
     on:
       branch: moschino
       php: 7.1
   - provider: script
     script: "$BLT_DIR/scripts/travis/deploy_branch"
     skip_cleanup: true
     on:
       branch: qa
       php: 7.1
   - provider: script
     script: "$BLT_DIR/scripts/travis/deploy_branch"
     skip_cleanup: true
     on:
       branch: uat
       php: 7.1
   - provider: script
     script: "$BLT_DIR/scripts/travis/deploy_branch"
     skip_cleanup: true
     on:
       branch: master
       php: 7.1
   - provider: script
     script: "$BLT_DIR/scripts/travis/deploy_tag"
     skip_cleanup: true
     on:
       tags: true
       php: 7.1
